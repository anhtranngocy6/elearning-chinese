<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N·ªÅn t·∫£ng H·ªçc Ti·∫øng Trung C√πng Th∆∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-active { border-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 0.75rem; background-color: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #loading-overlay { transition: opacity 0.3s ease-in-out; }
        .attendance-btn-active { background-color: #3b82f6 !important; color: white !important; border-color: #3b82f6 !important; }
        .attendance-btn-active.bg-red-500 { background-color: #ef4444 !important; border-color: #ef4444 !important; }
        .attendance-btn-active.bg-yellow-500 { background-color: #eab308 !important; border-color: #eab308 !important; }
        .attendance-btn-active.bg-orange-500 { background-color: #f97316 !important; border-color: #f97316 !important; }
        @keyframes toast-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toast-out { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .animate-toast-in { animation: toast-in 0.3s ease-out forwards; }
        .animate-toast-out { animation: toast-out 0.3s ease-in forwards; }
        ::-webkit-scrollbar { width: 8px; height: 8px;}
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="min-h-screen p-4 md:p-6 lg:p-8"></div>
    
    <div id="loading-overlay" class="fixed inset-0 bg-slate-50 flex items-center justify-center z-[100]">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i>
            <p class="mt-4 text-slate-600 font-semibold">ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm"></div>
    <div id="toast-container" class="fixed bottom-5 right-5 z-[101] space-y-3 w-full max-w-xs"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, writeBatch, setDoc, serverTimestamp, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===================================================================================
        // KHU V·ª∞C 1: KH·ªûI T·∫†O V√Ä TR·∫†NG TH√ÅI ·ª®NG D·ª§NG
        // ===================================================================================
        let db, auth;
        const firebaseConfig = {
            apiKey: "AIzaSyD7FL9Alrsci7uvi3UnCSYmsbyICxtDWR4",
            authDomain: "elearningenglishproject-4809b.firebaseapp.com",
            projectId: "elearningenglishproject-4809b",
            storageBucket: "elearningenglishproject-4809b.firebasestorage.app",
            messagingSenderId: "43710996622",
            appId: "1:43710996622:web:2f3e8d07424c0d0d5fa9df",
            measurementId: "G-VM1MSE4DM3"
        };
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("L·ªói kh·ªüi t·∫°o Firebase:", e);
            document.getElementById('loading-overlay').innerHTML = '<p class="text-red-500">L·ªói k·∫øt n·ªëi Firebase. Vui l√≤ng ki·ªÉm tra c·∫•u h√¨nh.</p>';
        }

        let users = [];
        let courses = [];
        let lessons = [];
        let homeworks = [];
        let progress = [];
        let enrollments = [];

        let currentUser = null;
        let currentView = 'login';
        let currentCourseId = null;
        let currentLessonId = null;
        let currentStudentIdForProgress = null;
        let overviewFilterLessonId = 'all';
        let currentActiveTab = 'overview'; // L∆∞u tab hi·ªán t·∫°i
        let isFirstNavigationAfterRestore = false;
        
        const appContainer = document.getElementById('app');
        const modalContainer = document.getElementById('modal-container');

        // ===================================================================================
        // KHU V·ª∞C 2: C√ÅC H√ÄM TI·ªÜN √çCH (UTILITIES)
        // ===================================================================================
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const icons = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' };
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
            const toast = document.createElement('div');
            toast.className = `flex items-center p-4 rounded-lg text-white shadow-2xl animate-toast-in ${colors[type]}`;
            toast.innerHTML = `<i class="fas ${icons[type]} mr-3"></i> <p>${message}</p>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.replace('animate-toast-in', 'animate-toast-out');
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        };

        const generateUsername = (fullName, role) => {
            const cleanName = fullName.replace(/^(GV\.|HS\.)\s*/, '');
            const nameParts = cleanName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().split(' ');
            if (nameParts.length === 0 || nameParts[0] === "") return "";
            if (nameParts.length === 1) return `${role === 'teacher' ? 'gv' : 'hs'}.${nameParts[0]}`;
            const lastName = nameParts[nameParts.length - 1];
            const initials = nameParts.slice(0, -1).map(part => part[0]).join('');
            let baseUsername = `${lastName}${initials}`;
            let username = `${role === 'teacher' ? 'gv' : 'hs'}.${baseUsername}`;
            let counter = 1;
            while (users.some(u => u.username === username)) {
                username = `${role === 'teacher' ? 'gv' : 'hs'}.${baseUsername}${counter}`;
                counter++;
            }
            return username;
        };

        const getYoutubeEmbedUrl = (url) => {
            if (!url) return null;
            let videoId = null;
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname === 'youtu.be') videoId = urlObj.pathname.slice(1);
                else if (urlObj.hostname.includes('youtube.com')) videoId = urlObj.searchParams.get('v');
            } catch (error) { return null; }
            return videoId ? `https://www.youtube.com/embed/${videoId}` : null;
        };

        const getUserInitials = (name) => {
            if (!name) return '??';
            return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        };
        
        const calculateAverageScore = () => {
            const scores = [];
            const readingInput = document.getElementById('edit-reading-score');
            const listeningInput = document.getElementById('edit-listening-score');
            const speakingInput = document.getElementById('edit-speaking-score');
            const writingInput = document.getElementById('edit-writing-score');

            // Ch·ªâ t√≠nh k·ªπ nƒÉng c√≥ input field (kh√¥ng b·ªã ·∫©n)
            if (readingInput && readingInput.offsetParent !== null && readingInput.value) scores.push(parseFloat(readingInput.value));
            if (listeningInput && listeningInput.offsetParent !== null && listeningInput.value) scores.push(parseFloat(listeningInput.value));
            if (speakingInput && speakingInput.offsetParent !== null && speakingInput.value) scores.push(parseFloat(speakingInput.value));
            if (writingInput && writingInput.offsetParent !== null && writingInput.value) scores.push(parseFloat(writingInput.value));
            
            const averageDisplay = document.getElementById('average-score-display');
            if (!averageDisplay) return;

            const validScores = scores.filter(s => !isNaN(s));

            if (validScores.length > 0) {
                const average = validScores.reduce((a, b) => a + b, 0) / validScores.length;
                averageDisplay.textContent = average.toFixed(1);
            } else {
                averageDisplay.textContent = '--';
            }
        };

        const renderCharts = (chartData, prefix = '') => {
            if (window.myCharts) { 
                Object.values(window.myCharts).forEach(chart => chart.destroy()); 
            }
            window.myCharts = {};
            const doughnutPieOptions = { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { 
                        display: true, 
                        position: 'bottom',
                        labels: {
                            boxWidth: 12
                        }
                    } 
                } 
            };

            const ctxSub = document.getElementById(`${prefix}submissionChart`);
            if (ctxSub) {
                window.myCharts.submission = new Chart(ctxSub, { type: 'doughnut', data: chartData.submission, options: doughnutPieOptions });
            }

            const ctxGrade = document.getElementById(`${prefix}gradingChart`);
            if (ctxGrade && chartData.grading.datasets[0].data.reduce((a, b) => a + b, 0) > 0) {
                window.myCharts.grading = new Chart(ctxGrade, { type: 'doughnut', data: chartData.grading, options: doughnutPieOptions });
            } else if (ctxGrade) {
                const ctx = ctxGrade.getContext('2d');
                ctx.clearRect(0, 0, ctxGrade.width, ctxGrade.height);
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#64748b';
                ctx.fillText('Ch∆∞a c√≥ b√†i n·ªôp', ctxGrade.width / 2, ctxGrade.height / 2);
            }

            const ctxAtt = document.getElementById(`${prefix}attendanceChart`);
            if(ctxAtt) {
                window.myCharts.attendance = new Chart(ctxAtt, { 
                    type: 'pie', 
                    data: chartData.attendance, 
                    options: doughnutPieOptions
                });
            }
            
            const ctxSkills = document.getElementById(`${prefix}skillsChart`);
            if(ctxSkills) {
                window.myCharts.skills = new Chart(ctxSkills, {
                    type: 'radar',
                    data: chartData.skills,
                    options: { 
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'bottom' } },
                        scales: { 
                            r: { 
                                angleLines: { display: false },
                                suggestedMin: 0,
                                suggestedMax: 10,
                                ticks: { stepSize: 2 } 
                            } 
                        } 
                    }
                });
            }
        };

        const showModal = (content) => {
            if (typeof content === 'string') {
                modalContainer.innerHTML = content;
            } else if (content instanceof HTMLElement) {
                modalContainer.innerHTML = '';
                modalContainer.appendChild(content);
            }
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
        };

        const closeModal = () => {
            modalContainer.classList.add('hidden');
            modalContainer.innerHTML = '';
        };

        // Helper function to get skill badge color classes based on score
        const getSkillColorClass = (score) => {
            if (score === '--' || score === null || score === undefined) {
                return 'bg-slate-200 text-slate-700';
            }
            const numScore = parseFloat(score);
            if (numScore < 5) {
                return 'bg-red-100 text-red-700';
            } else if (numScore >= 5 && numScore < 8) {
                return 'bg-yellow-100 text-yellow-700';
            } else {
                return 'bg-green-100 text-green-700';
            }
        };

        // ===================================================================================
        // KHU V·ª∞C 3: C√ÅC H√ÄM RENDER GIAO DI·ªÜN (UI RENDERING FUNCTIONS)
        // ===================================================================================

        const renderLoginScreen = () => {
            document.title = "ƒêƒÉng nh·∫≠p | H·ªçc Ti·∫øng Trung C√πng Th∆∞";
            appContainer.innerHTML = `
             <div class="min-h-screen flex flex-col items-center justify-center bg-slate-100 bg-cover bg-center" style="background-image: url('https://placehold.co/1920x1080/e2e8f0/e2e8f0?text=.')">
                 <div class="w-full max-w-md bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl fade-in">
                     <div class="text-center mb-8">
                         <i class="fas fa-graduation-cap text-5xl text-blue-600"></i>
                         <h1 class="text-4xl font-bold text-slate-800 mt-2">H·ªçc Ti·∫øng Trung C√πng Th∆∞</h1>
                         <p class="text-slate-500">Ch√†o m·ª´ng b·∫°n tr·ªü l·∫°i!</p>
                     </div>
                     <div id="login-error" class="text-red-500 text-center mb-4 hidden"></div>
                     <div class="space-y-4">
                         <div>
                             <label for="username-input" class="block text-sm font-medium text-slate-600 mb-1">T√™n ƒëƒÉng nh·∫≠p:</label>
                             <input type="text" id="username-input" class="w-full p-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition-shadow" placeholder="v√≠ d·ª•: hs.annv">
                         </div>
                         <div>
                             <label for="password-input" class="block text-sm font-medium text-slate-600 mb-1">M·∫≠t kh·∫©u:</label>
                             <input type="password" id="password-input" class="w-full p-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition-shadow" placeholder="******">
                         </div>
                         <button id="login-btn" class="w-full bg-blue-600 text-white font-semibold p-3 rounded-lg hover:bg-blue-700 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5">ƒêƒÉng nh·∫≠p</button>
                     </div>
                 </div>
             </div>`;
        };

        const renderHeader = (title, showBackButton = false) => {
            return `
                 <header class="w-full bg-white p-4 rounded-xl shadow-lg flex justify-between items-center sticky top-0 z-40 h-20">
                     <div class="flex items-center min-w-0">
                         ${showBackButton ? '<button class="back-btn mr-4 text-slate-500 hover:text-blue-600 transition-colors"><i class="fas fa-arrow-left fa-lg"></i></button>' : ''}
                         <h1 class="text-xl md:text-2xl font-bold text-slate-800 truncate">${title}</h1>
                     </div>
                     <div class="flex items-center space-x-4">
                         <div class="hidden md:flex items-center space-x-2">
                            <div class="h-10 w-10 bg-blue-100 text-blue-600 font-bold rounded-full flex items-center justify-center">${getUserInitials(currentUser.name)}</div>
                            <div class="text-right">
                                <p class="font-semibold text-sm text-slate-700">${currentUser.name}</p>
                                <p class="text-xs text-slate-500 capitalize">${currentUser.role}</p>
                            </div>
                         </div>
                         <button id="logout-btn" class="bg-red-500 text-white font-semibold px-3 py-2 rounded-lg hover:bg-red-600 transition-colors">
                             <i class="fas fa-sign-out-alt"></i>
                         </button>
                     </div>
                 </header>`;
        };
        
        const renderConfirmModal = (title, message, confirmText, confirmClass, onConfirm) => {
            const confirmModal = document.createElement('div');
            confirmModal.className = "bg-white w-full max-w-sm rounded-xl shadow-lg p-6 fade-in";
            confirmModal.innerHTML = `
                 <h2 class="text-xl font-bold mb-2 text-slate-800">${title}</h2>
                 <p class="text-slate-600 mb-6">${message}</p>
                 <div class="flex justify-end space-x-3 pt-2">
                     <button class="cancel-modal-btn px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Hu·ª∑</button>
                     <button class="confirm-action px-4 py-2 text-white rounded-lg ${confirmClass}">${confirmText}</button>
                 </div>
            `;
            
            showModal(confirmModal);

            confirmModal.querySelector('.confirm-action').addEventListener('click', () => { onConfirm(); closeModal(); }, { once: true });
            confirmModal.querySelector('.cancel-modal-btn').addEventListener('click', closeModal, { once: true });
        };
        
        const renderAdminDashboard = () => {
             document.title = "Admin Dashboard | H·ªçc Ti·∫øng Trung C√πng Th∆∞";
            const teachers = users.filter(u => u.role === 'teacher');
            const students = users.filter(u => u.role === 'student');

            appContainer.innerHTML = `
                 <div class="w-full max-w-7xl mx-auto fade-in">
                     ${renderHeader('Admin Dashboard')}
                     <main class="mt-6">
                         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                             <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4"><div class="bg-blue-100 text-blue-600 p-4 rounded-full"><i class="fas fa-chalkboard-teacher fa-xl"></i></div><div><p class="text-slate-500 text-sm">Gi√°o vi√™n</p><p class="text-2xl font-bold">${teachers.length}</p></div></div>
                             <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4"><div class="bg-green-100 text-green-600 p-4 rounded-full"><i class="fas fa-user-graduate fa-xl"></i></div><div><p class="text-slate-500 text-sm">H·ªçc sinh</p><p class="text-2xl font-bold">${students.length}</p></div></div>
                             <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4"><div class="bg-purple-100 text-purple-600 p-4 rounded-full"><i class="fas fa-book-open fa-xl"></i></div><div><p class="text-slate-500 text-sm">Kho√° h·ªçc</p><p class="text-2xl font-bold">${courses.length}</p></div></div>
                              <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4"><div class="bg-yellow-100 text-yellow-600 p-4 rounded-full"><i class="fas fa-tasks fa-xl"></i></div><div><p class="text-slate-500 text-sm">L∆∞·ª£t Ghi danh</p><p class="text-2xl font-bold">${enrollments.length}</p></div></div>
                         </div>

                         <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                             <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                                 <div class="bg-white p-6 rounded-xl shadow-lg">
                                     <h2 class="text-xl font-bold mb-4">Qu·∫£n l√Ω Gi√°o vi√™n</h2>
                                     <div class="space-y-2 pt-4 border-t">
                                         <input type="text" id="new-teacher-name" placeholder="H·ªç v√† t√™n gi√°o vi√™n" class="w-full p-2 border rounded-lg">
                                         <input type="password" id="new-teacher-password" placeholder="M·∫≠t kh·∫©u ban ƒë·∫ßu" class="w-full p-2 border rounded-lg">
                                         <button id="add-teacher-btn" class="w-full bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600">Th√™m Gi√°o vi√™n</button>
                                     </div>
                                     <div class="space-y-2 mt-4 max-h-60 overflow-y-auto pr-2">${teachers.map(t => `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg"><div><p class="font-medium">${t.name}</p><p class="text-xs text-slate-500">${t.username}</p></div><button class="delete-user-btn text-red-500 hover:text-red-700" data-id="${t.id}"><i class="fas fa-trash"></i></button></div>`).join('') || '<p class="text-sm text-slate-500">Ch∆∞a c√≥ gi√°o vi√™n.</p>'}</div>
                                 </div>
                                 <div class="bg-white p-6 rounded-xl shadow-lg">
                                     <h2 class="text-xl font-bold mb-4">Qu·∫£n l√Ω H·ªçc sinh</h2>
                                     <div class="space-y-3 pt-4 border-t">
                                         <input type="text" id="new-student-name" placeholder="H·ªç v√† t√™n h·ªçc sinh" class="w-full p-2 border rounded-lg">
                                         <input type="password" id="new-student-password" placeholder="M·∫≠t kh·∫©u ban ƒë·∫ßu" class="w-full p-2 border rounded-lg">
                                         <select id="admin-teacher-select" class="w-full p-2 border border-slate-300 rounded-lg"><option value="">-- Ch·ªçn gi√°o vi√™n --</option>${teachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}</select>
                                         <select id="admin-course-select" class="w-full p-2 border border-slate-300 rounded-lg" disabled><option value="">-- Ch·ªçn kho√° h·ªçc --</option></select>
                                         <button id="add-student-btn" class="w-full bg-green-500 text-white p-2 rounded-lg hover:bg-green-600">Th√™m v√† Ghi danh</button>
                                     </div>
                                      <div class="space-y-2 mt-4 max-h-60 overflow-y-auto pr-2">${students.map(s => `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg"><div><p class="font-medium">${s.name}</p><p class="text-xs text-slate-500">${s.username}</p></div><div class="space-x-3"><button class="edit-student-btn text-blue-500 hover:text-blue-700" data-id="${s.id}"><i class="fas fa-edit"></i></button><button class="delete-user-btn text-red-500 hover:text-red-700" data-id="${s.id}"><i class="fas fa-trash"></i></button></div></div>`).join('') || '<p class="text-sm text-slate-500">Ch∆∞a c√≥ h·ªçc sinh.</p>'}</div>
                                 </div>
                             </div>
                             <div class="bg-white p-6 rounded-xl shadow-lg">
                                 <h2 class="text-xl font-bold mb-4">T·ªïng quan Kho√° h·ªçc</h2>
                                 <div class="space-y-4 max-h-[42rem] overflow-y-auto pr-2">${courses.map(c => { const teacher = users.find(u => u.id === c.createdBy); const studentCount = enrollments.filter(e => e.courseId === c.id).length; const lessonCount = lessons.filter(l => l.courseId === c.id).length; return `<div class="flex items-start p-4 bg-slate-50 rounded-lg space-x-4 hover:bg-slate-100 transition-colors cursor-pointer view-course-detail-btn" data-id="${c.id}"><div class="flex-shrink-0 h-12 w-12 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center"><i class="fas fa-book-open fa-lg"></i></div><div><h4 class="font-bold text-slate-800">${c.title}</h4><p class="text-sm text-slate-500">GV: ${teacher?.name}</p><div class="flex items-center space-x-4 mt-2 text-xs text-slate-600"><span class="flex items-center" title="${studentCount} h·ªçc sinh"><i class="fas fa-users mr-1.5 text-gray-400"></i> ${studentCount}</span><span class="flex items-center" title="${lessonCount} b√†i h·ªçc"><i class="fas fa-list-alt mr-1.5 text-gray-400"></i> ${lessonCount}</span></div></div></div>` }).join('') || '<p class="text-sm text-slate-500 text-center py-4">Ch∆∞a c√≥ kh√≥a h·ªçc n√†o.</p>'}</div>
                             </div>
                         </div>
                     </main>
                 </div>`;
        };
        const renderCourseDetailModal = (courseId) => {
            const course = courses.find(c => c.id === courseId);
            if (!course) return;
            const courseLessons = lessons.filter(l => l.courseId === courseId);
            const enrolledStudentIds = enrollments.filter(e => e.courseId === courseId).map(e => e.studentId);
            const enrolledStudents = users.filter(u => enrolledStudentIds.includes(u.id));
            const modalContent = `<div class="bg-white w-full max-w-2xl rounded-xl shadow-lg p-6 fade-in"><div class="flex justify-between items-center border-b pb-3 mb-4"><h2 class="text-2xl font-bold text-slate-800">${course.title}</h2><button class="cancel-modal-btn text-slate-400 hover:text-slate-800 text-3xl font-light">&times;</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[60vh] overflow-y-auto pr-2"><div><h3 class="font-semibold text-lg mb-3 flex items-center"><i class="fas fa-list-alt mr-2 text-gray-500"></i>C√°c b√†i h·ªçc</h3><ul class="space-y-2">${courseLessons.length > 0 ? courseLessons.map(l => `<li class="p-2 bg-slate-100 rounded-md text-sm">${l.title}</li>`).join('') : '<li class="text-sm text-slate-500">Ch∆∞a c√≥ b√†i h·ªçc n√†o.</li>'}</ul></div><div><h3 class="font-semibold text-lg mb-3 flex items-center"><i class="fas fa-users mr-2 text-gray-500"></i>H·ªçc sinh tham gia</h3><ul class="space-y-2">${enrolledStudents.length > 0 ? enrolledStudents.map(s => `<li class="p-2 bg-slate-100 rounded-md text-sm">${s.name}</li>`).join('') : '<li class="text-sm text-slate-500">Ch∆∞a c√≥ h·ªçc sinh n√†o.</li>'}</ul></div></div></div>`;
            return modalContent;
        };
        const renderEditStudentModal = (studentId) => {
            const student = users.find(u => u.id === studentId);
            if (!student) return;
            const studentEnrollments = enrollments.filter(e => e.studentId === studentId).map(e => e.courseId);
            const modalContent = `<div class="bg-white w-full max-w-lg rounded-xl shadow-lg p-6 fade-in" id="edit-student-modal"><h2 class="text-2xl font-bold mb-4">Ch·ªânh s·ª≠a ghi danh cho ${student.name}</h2><p class="text-slate-600 mb-6">Ch·ªçn c√°c kho√° h·ªçc m√† h·ªçc sinh n√†y s·∫Ω tham gia.</p><div class="space-y-3 max-h-60 overflow-y-auto pr-2">${courses.map(course => { const isEnrolled = studentEnrollments.includes(course.id); const teacher = users.find(u => u.id === course.createdBy); return `<label class="flex items-center p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-course-id="${course.id}" ${isEnrolled ? 'checked' : ''}><div class="ml-4"><span class="font-medium text-slate-800">${course.title}</span><p class="text-sm text-slate-500">GV: ${teacher?.name}</p></div></label>`; }).join('')}</div><div class="mt-6 flex justify-end space-x-3"><button class="cancel-modal-btn px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Hu·ª∑</button><button id="save-enrollment-btn" data-student-id="${studentId}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">L∆∞u thay ƒë·ªïi</button></div></div>`;
            return modalContent;
        };
        const renderPasswordConfirmModal = (userId, userName) => {
             const modalContent = `<div class="bg-white w-full max-w-sm rounded-xl shadow-lg p-6 fade-in"><h2 class="text-xl font-bold mb-2 text-slate-800">X√°c nh·∫≠n H√†nh ƒë·ªông</h2><p class="text-slate-600 mb-4">B·∫°n ƒëang chu·∫©n b·ªã xo√° ng∆∞·ªùi d√πng <strong class="font-semibold">${userName}</strong>. Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u c·ªßa b·∫°n ƒë·ªÉ x√°c nh·∫≠n.</p><div id="delete-error" class="text-red-500 text-center mb-4 text-sm hidden"></div><div class="space-y-3"><div><label for="admin-password-confirm" class="block text-sm font-medium text-slate-600 mb-1">M·∫≠t kh·∫©u Admin:</label><input type="password" id="admin-password-confirm" class="w-full p-2 border rounded-lg" placeholder="******"></div><div class="flex justify-end space-x-3 pt-2"><button class="cancel-modal-btn px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Hu·ª∑</button><button id="confirm-delete-btn" data-user-id="${userId}" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">X√°c nh·∫≠n Xo√°</button></div></div></div>`;
            return modalContent;
        };
        
        const renderTeacherDashboard = () => {
             if (currentView !== 'course' && currentView !== 'studentProgress' && currentView !== 'studentReport') {
                 currentView = 'dashboard';
             }
             document.title = "Teacher Dashboard | H·ªçc Ti·∫øng Trung C√πng Th∆∞";
            const myCourses = courses.filter(c => c.createdBy === currentUser.id);
            appContainer.innerHTML = `<div class="w-full max-w-7xl mx-auto fade-in">${renderHeader('Teacher Dashboard')}<div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-6"><div class="md:col-span-2 bg-white p-6 rounded-xl shadow-lg"><h2 class="text-2xl font-bold mb-4">Kho√° h·ªçc c·ªßa t√¥i</h2><div class="space-y-3">${myCourses.length > 0 ? myCourses.map(c => `<div class="p-4 bg-slate-50 rounded-lg flex justify-between items-center"><div><h3 class="font-semibold text-lg">${c.title}</h3><p class="text-sm text-slate-500 truncate">${c.description}</p></div><div class="space-x-2 flex-shrink-0"><button class="edit-course-btn text-gray-500 hover:text-blue-700" data-id="${c.id}" title="Ch·ªânh s·ª≠a th√¥ng tin"><i class="fas fa-pen"></i></button><button class="manage-course-btn bg-blue-50 text-blue-600 px-4 py-1 rounded-full border border-blue-200 font-semibold text-sm hover:bg-blue-100" data-id="${c.id}">Qu·∫£n l√Ω</button></div></div>`).join('') : '<p class="text-slate-500">B·∫°n ch∆∞a t·∫°o kho√° h·ªçc n√†o.</p>'}</div></div><div class="bg-white p-6 rounded-xl shadow-lg h-fit"><h2 class="text-2xl font-bold mb-4">T·∫°o kho√° h·ªçc m·ªõi</h2><div class="space-y-3"><input type="text" id="new-course-title" placeholder="Ti√™u ƒë·ªÅ kho√° h·ªçc" class="w-full p-2 border rounded-lg"><textarea id="new-course-desc" placeholder="M√¥ t·∫£ kho√° h·ªçc" class="w-full p-2 border rounded-lg h-24"></textarea><input type="text" id="new-course-folder-url" placeholder="Link th∆∞ m·ª•c Google Drive cho kho√° h·ªçc" class="w-full p-2 border rounded-lg"><button id="add-course-btn" class="w-full bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700">T·∫°o m·ªõi</button></div></div></div></div>`;
        };
        const renderEditCourseModal = (courseId) => {
            const course = courses.find(c => c.id === courseId);
            if (!course) return;
            const modalContent = `
                 <div class="bg-white w-full max-w-lg rounded-xl shadow-lg p-6 fade-in">
                     <h2 class="text-2xl font-bold mb-4">Ch·ªânh s·ª≠a Kho√° h·ªçc</h2>
                     <div class="space-y-4">
                         <div>
                             <label for="edit-course-title" class="block text-sm font-medium text-slate-600 mb-1">Ti√™u ƒë·ªÅ kho√° h·ªçc:</label>
                             <input type="text" id="edit-course-title" class="w-full p-2 border rounded-lg" value="${course.title}">
                         </div>
                         <div>
                             <label for="edit-course-desc" class="block text-sm font-medium text-slate-600 mb-1">M√¥ t·∫£:</label>
                             <textarea id="edit-course-desc" class="w-full p-2 border rounded-lg h-24">${course.description}</textarea>
                         </div>
                         <div>
                             <label for="edit-course-folder-url" class="block text-sm font-medium text-slate-600 mb-1">Link th∆∞ m·ª•c Google Drive:</label>
                             <input type="text" id="edit-course-folder-url" class="w-full p-2 border rounded-lg" value="${course.submissionFolderUrl || ''}">
                         </div>
                     </div>
                     <div class="mt-6 flex justify-end space-x-3">
                         <button class="cancel-modal-btn px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Hu·ª∑</button>
                         <button id="save-course-btn" data-course-id="${courseId}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">L∆∞u thay ƒë·ªïi</button>
                     </div>
                 </div>
            `;
            return modalContent;
        };
        const renderTeacherCourseManagement = (courseId, isRestoring = false) => {
            if (!isRestoring) {
                currentView = 'course';
            }
            currentCourseId = courseId;
            const course = courses.find(c => c.id === courseId);
            if(!course) return renderTeacherDashboard();
            document.title = `Qu·∫£n l√Ω: ${course.title}`;
            
            appContainer.innerHTML = `
                 <div class="w-full max-w-7xl mx-auto fade-in">
                     ${renderHeader(course.title, true)}
                     <main class="mt-6">
                         <div class="border-b border-gray-200 mb-6 bg-white/80 backdrop-blur-sm shadow-sm rounded-t-lg sticky top-20 z-30">
                             <nav class="-mb-px flex space-x-6 overflow-x-auto px-6">
                                 <button data-tab="overview" class="tab-btn ${currentActiveTab === 'overview' ? 'tab-active' : 'text-gray-500 hover:text-gray-700'} whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">T·ªïng quan</button>
                                 <button data-tab="lessons" class="tab-btn ${currentActiveTab === 'lessons' ? 'tab-active' : 'text-gray-500 hover:text-gray-700'} whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">B√†i h·ªçc</button>
                                 <button data-tab="students-progress" class="tab-btn ${currentActiveTab === 'students-progress' ? 'tab-active' : 'text-gray-500 hover:text-gray-700'} whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">H·ªçc sinh & Ti·∫øn ƒë·ªô</button>
                             </nav>
                         </div>

                         <div class="bg-white p-6 md:p-8 rounded-b-xl shadow-lg -mt-8 pt-14">
                             <div id="tab-overview" class="tab-content ${currentActiveTab === 'overview' ? '' : 'hidden'}"></div>
                             <div id="tab-lessons" class="tab-content ${currentActiveTab === 'lessons' ? '' : 'hidden'}"></div>
                             <div id="tab-students-progress" class="tab-content ${currentActiveTab === 'students-progress' ? '' : 'hidden'}"></div>
                         </div>
                     </main>
                 </div>`;
            
            updateTeacherCourseTabs();
        };

        const updateTeacherCourseTabs = () => {
            if (currentView !== 'course' || currentUser?.role !== 'teacher') return;
            const courseId = currentCourseId;
            const enrolledStudents = users.filter(u => u.role === 'student' && enrollments.some(e => e.courseId === courseId && e.studentId === u.id));

            const overviewResult = renderTeacherCourseTabs.overview(courseId, enrolledStudents);
            const overviewTab = document.getElementById('tab-overview');
            if(overviewTab) {
                overviewTab.innerHTML = overviewResult.html;
                if(overviewResult.chartData) {
                    // Use a short timeout to ensure the canvas elements are in the DOM
                    setTimeout(() => renderCharts(overviewResult.chartData, 'overview-'), 50);
                }
            }
            
            const lessonsTab = document.getElementById('tab-lessons');
            if (lessonsTab) {
                lessonsTab.innerHTML = renderTeacherCourseTabs.lessons(courseId);
            }

            const studentsTab = document.getElementById('tab-students-progress');
            if (studentsTab) {
                studentsTab.innerHTML = renderTeacherCourseTabs.students(courseId, enrolledStudents);
            }
        };

        const renderTeacherCourseTabs = {
            overview: (courseId, enrolledStudents) => {
                let allLessonsWithHomework = lessons
                    .filter(l => l.courseId === courseId && homeworks.some(h => h.lessonId === l.id))
                    .sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                
                const allLessonsInCourse = lessons.filter(l => l.courseId === courseId);

                if (enrolledStudents.length === 0 ) {
                    return { html: '<div class="text-center py-12"><i class="fas fa-info-circle fa-2x text-slate-400"></i><p class="mt-4 text-slate-500">Ch∆∞a c√≥ h·ªçc sinh trong kh√≥a h·ªçc.</p></div>' };
                }
                if (allLessonsWithHomework.length === 0) {
                     return { html: '<div class="text-center py-12"><i class="fas fa-info-circle fa-2x text-slate-400"></i><p class="mt-4 text-slate-500">Ch∆∞a c√≥ b√†i t·∫≠p n√†o ƒë·ªÉ hi·ªÉn th·ªã t·ªïng quan.</p></div>'};
                }
                
                const lessonsForStats = overviewFilterLessonId === 'all' 
                    ? allLessonsWithHomework 
                    : allLessonsWithHomework.filter(l => l.id === overviewFilterLessonId);
                
                let totalSubmissions = 0, totalGraded = 0;
                let totalPresent = 0, totalLate = 0, totalAbsentExcused = 0, totalAbsentUnexcused = 0;
                const totalPossibleSubmissions = enrolledStudents.length * lessonsForStats.length;
                const totalAttendanceSlots = enrolledStudents.length * allLessonsInCourse.length;
                
                const allReadingScores = [], allListeningScores = [], allSpeakingScores = [], allWritingScores = [];

                enrolledStudents.forEach(student => {
                    lessonsForStats.forEach(lesson => {
                        const progressRecord = progress.find(p => p.studentId === student.id && p.lessonId === lesson.id);
                        if (progressRecord?.submittedAt) {
                            totalSubmissions++;
                            if (progressRecord.grade != null) {
                                totalGraded++;
                                if (progressRecord.grades) {
                                    allReadingScores.push(progressRecord.grades.reading ?? 0);
                                    allListeningScores.push(progressRecord.grades.listening ?? 0);
                                    allSpeakingScores.push(progressRecord.grades.speaking ?? 0);
                                    allWritingScores.push(progressRecord.grades.writing ?? 0);
                                }
                            }
                        }
                    });
                    allLessonsInCourse.forEach(lesson => {
                        const progressRecord = progress.find(p => p.studentId === student.id && p.lessonId === lesson.id);
                        if (progressRecord?.attendanceStatus) {
                            switch (progressRecord.attendanceStatus) {
                                case 'present': totalPresent++; break;
                                case 'late': totalLate++; break;
                                case 'absent_excused': totalAbsentExcused++; break;
                                case 'absent_unexcused': totalAbsentUnexcused++; break;
                            }
                        }
                    });
                });

                const calculateAverage = (scores) => scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : '--';
                const classAvgReading = calculateAverage(allReadingScores);
                const classAvgListening = calculateAverage(allListeningScores);
                const classAvgSpeaking = calculateAverage(allSpeakingScores);
                const classAvgWriting = calculateAverage(allWritingScores);
                
                const totalRecorded = totalPresent + totalLate + totalAbsentExcused + totalAbsentUnexcused;
                const totalNotRecorded = totalAttendanceSlots - totalRecorded;
                
                const chartData = {
                    submission: {
                        labels: ['ƒê√£ n·ªôp', 'Ch∆∞a n·ªôp'],
                        datasets: [{ data: [totalSubmissions, totalPossibleSubmissions > totalSubmissions ? totalPossibleSubmissions - totalSubmissions : 0], backgroundColor: ['#3b82f6', '#e2e8f0']}]
                    },
                    grading: {
                        labels: ['ƒê√£ ch·∫•m', 'Ch∆∞a ch·∫•m'],
                        datasets: [{ data: [totalGraded, totalSubmissions - totalGraded], backgroundColor: ['#22c55e', '#facc15']}]
                    },
                    attendance: {
                        labels: ['C√≥ m·∫∑t', 'ƒêi tr·ªÖ', 'V·∫Øng c√≥ ph√©p', 'V·∫Øng kh√¥ng ph√©p', 'Ch∆∞a ƒëi·ªÉm danh'],
                        datasets: [{ data: [totalPresent, totalLate, totalAbsentExcused, totalAbsentUnexcused, totalNotRecorded], backgroundColor: ['#22c55e', '#f97316', '#facc15', '#ef4444', '#e2e8f0'] }]
                    },
                    skills: {
                        labels: ['ƒê·ªçc', 'Nghe', 'N√≥i', 'Vi·∫øt'],
                        datasets: [{ 
                            label: 'ƒêi·ªÉm trung b√¨nh', 
                            data: [classAvgReading, classAvgListening, classAvgSpeaking, classAvgWriting].map(s => s === '--' ? 0 : s),
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        }]
                    }
                };

                const lessonsForTable = (overviewFilterLessonId === 'all') 
                    ? allLessonsWithHomework 
                    : allLessonsWithHomework.filter(l => l.id === overviewFilterLessonId);

                const filterMessage = "Nh·∫•n v√†o √¥ ƒë·ªÉ ch·ªânh s·ª≠a nhanh. üü¢ Xanh = ƒë√£ ch·∫•m | üü° V√†ng = ch∆∞a ch·∫•m | üî¥ ƒê·ªè = ch∆∞a n·ªôp";

                // Heatmap view (12 b√†i 1 d√≤ng, xu·ªëng h√†ng khi v∆∞·ª£t qu√°)
                const heatmapView = enrolledStudents.length > 0 
                    ? `<div class="rounded-2xl overflow-hidden shadow-2xl border-2 border-slate-100 bg-white">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-blue-700 to-blue-600 px-8 py-6 text-white">
                            <h3 class="text-2xl font-bold mb-3">üìä B·∫£ng Ti·∫øn ƒê·ªô H·ªçc T·∫≠p</h3>
                            <div class="flex flex-wrap gap-6 text-sm font-medium">
                                <div class="flex items-center gap-3"><div class="w-4 h-4 bg-green-400 rounded-full shadow-md"></div><span>ƒê√£ ch·∫•m</span></div>
                                <div class="flex items-center gap-3"><div class="w-4 h-4 bg-yellow-300 rounded-full shadow-md"></div><span>Ch∆∞a ch·∫•m</span></div>
                                <div class="flex items-center gap-3"><div class="w-4 h-4 bg-red-400 rounded-full shadow-md"></div><span>Ch∆∞a n·ªôp</span></div>
                            </div>
                        </div>

                        <!-- Column headers -->
                        <div class="bg-gradient-to-r from-slate-50 to-slate-100 border-b-4 border-slate-300 px-6 py-4 grid grid-cols-12 gap-0 sticky top-0 z-10">
                            <div class="col-span-2 pr-4"><span class="text-sm font-bold text-slate-800 uppercase tracking-wider">H·ªçc sinh</span></div>
                            <div class="col-span-6 pr-4"><span class="text-sm font-bold text-slate-800 uppercase tracking-wider">Ti·∫øn ƒë·ªô</span></div>
                            <div class="col-span-2 pr-4 text-center"><span class="text-sm font-bold text-slate-800 uppercase tracking-wider">K·ªπ nƒÉng</span></div>
                            <div class="col-span-2 pl-4 text-center"><span class="text-sm font-bold text-slate-800 uppercase tracking-wider">ƒêi·ªÉm trung b√¨nh</span></div>
                        </div>

                        <!-- Rows -->
                        <div class="divide-y-2 divide-slate-200">
                            ${enrolledStudents.map((student, rowIdx) => {
                                let totalScore = 0, scoredCount = 0;
                                const dotsHtml = lessonsForTable.map((lesson, idx) => {
                                    const progressRecord = progress.find(p => p.studentId === student.id && p.lessonId === lesson.id);
                                    let dotClass = 'bg-red-400';
                                    let tooltipText = 'Ch∆∞a n·ªôp';
                                    
                                    if (progressRecord?.submittedAt) {
                                        if (progressRecord.grade === null || progressRecord.grade === undefined) {
                                            dotClass = 'bg-yellow-300';
                                            tooltipText = 'Ch∆∞a ch·∫•m';
                                        } else {
                                            dotClass = 'bg-green-400';
                                            tooltipText = 'ƒêi·ªÉm: ' + progressRecord.grade;
                                            totalScore += parseFloat(progressRecord.grade);
                                            scoredCount++;
                                        }
                                    }
                                    
                                    return '<div class="flex flex-col items-center edit-progress-shortcut-btn cursor-pointer group" data-student-id="' + student.id + '" data-lesson-id="' + lesson.id + '" title="' + tooltipText + ' - ' + lesson.title + '"><div class="w-6 h-6 rounded-full ' + dotClass + ' hover:scale-125 transition-all shadow-md ring-1 ring-offset-1 ring-white hover:ring-blue-400 group-hover:shadow-lg"></div><span class="text-xs font-bold text-slate-700 mt-1">' + (idx + 1) + '</span></div>';
                                }).join('');
                                
                                const avgScore = scoredCount > 0 ? (totalScore / scoredCount).toFixed(1) : '--';
                                
                                // Calculate skill averages for this student
                                // Sum all grades from graded work only (grade != null)
                                const studentSkillTotals = { reading: 0, listening: 0, speaking: 0, writing: 0 };
                                let gradedCount = 0;
                                lessonsForTable.forEach(lesson => {
                                    const pRecord = progress.find(p => p.studentId === student.id && p.lessonId === lesson.id && p.submittedAt && p.grade != null);
                                    if (pRecord) {
                                        studentSkillTotals.reading += pRecord.grades?.reading ?? 0;
                                        studentSkillTotals.listening += pRecord.grades?.listening ?? 0;
                                        studentSkillTotals.speaking += pRecord.grades?.speaking ?? 0;
                                        studentSkillTotals.writing += pRecord.grades?.writing ?? 0;
                                        gradedCount++;
                                    }
                                });
                                
                                const readingAvg = gradedCount > 0 ? (studentSkillTotals.reading / gradedCount).toFixed(1) : '--';
                                const listeningAvg = gradedCount > 0 ? (studentSkillTotals.listening / gradedCount).toFixed(1) : '--';
                                const speakingAvg = gradedCount > 0 ? (studentSkillTotals.speaking / gradedCount).toFixed(1) : '--';
                                const writingAvg = gradedCount > 0 ? (studentSkillTotals.writing / gradedCount).toFixed(1) : '--';
                                
                                const skillsHtml = `<div class="flex flex-col gap-6 items-center justify-center">
                                    <div class="flex gap-6">
                                        <span class="inline-block w-12 px-2 py-1.5 rounded-lg text-xs font-bold text-center ${getSkillColorClass(listeningAvg)} shadow-sm">Nghe ${listeningAvg}</span>
                                        <span class="inline-block w-12 px-2 py-1.5 rounded-lg text-xs font-bold text-center ${getSkillColorClass(readingAvg)} shadow-sm">ƒê·ªçc ${readingAvg}</span>
                                    </div>
                                    <div class="flex gap-6">
                                        <span class="inline-block w-12 px-2 py-1.5 rounded-lg text-xs font-bold text-center ${getSkillColorClass(speakingAvg)} shadow-sm">N√≥i ${speakingAvg}</span>
                                        <span class="inline-block w-12 px-2 py-1.5 rounded-lg text-xs font-bold text-center ${getSkillColorClass(writingAvg)} shadow-sm">Vi·∫øt ${writingAvg}</span>
                                    </div>
                                </div>`;
                                
                                return '<div class="grid grid-cols-12 gap-0 px-6 py-5 items-center hover:bg-gradient-to-r hover:from-blue-50 hover:to-transparent transition-all ' + (rowIdx % 2 === 0 ? 'bg-white' : 'bg-slate-50') + '"><div class="col-span-2 pr-4"><span class="font-semibold text-sm text-slate-900 cursor-pointer hover:text-blue-700 view-student-progress-btn block truncate transition-colors" data-student-id="' + student.id + '" title="Click ƒë·ªÉ xem b√°o c√°o - ' + student.name + '">' + student.name + '</span></div><div class="col-span-6 flex flex-wrap gap-3 justify-start items-center content-center">' + dotsHtml + '</div><div class="col-span-2 flex items-center justify-center">' + skillsHtml + '</div><div class="col-span-2 pl-4 text-center"><span class="inline-block font-bold text-xl text-white bg-gradient-to-r from-blue-700 to-blue-600 px-4 py-3 rounded-full shadow-lg hover:shadow-xl transition-shadow">' + avgScore + '</span></div></div>';
                            }).join('')}
                        </div>
                    </div>`
                    : '';

                const tableOrMessage = heatmapView;
                
                const html = `
                <div>
                    <h3 class="text-xl font-bold mb-4">T·ªïng quan ti·∫øn ƒë·ªô l·ªõp h·ªçc</h3>
                    <div class="mb-8 p-6 bg-slate-50 rounded-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold text-slate-700">Th·ªëng k√™ chung</h4>
                            <div class="flex items-center">
                                <label for="overview-filter" class="text-sm font-medium text-slate-600">L·ªçc theo:</label>
                                <select id="overview-filter" class="ml-2 p-1.5 border rounded-md text-sm bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="all">T·∫•t c·∫£ b√†i t·∫≠p</option>
                                    ${allLessonsWithHomework.map(l => `<option value="${l.id}" ${overviewFilterLessonId === l.id ? 'selected' : ''}>${l.title}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-white p-4 rounded-xl shadow-lg flex flex-col h-72"><h5 class="text-center font-semibold text-slate-600 mb-2 flex-shrink-0">T·ªâ l·ªá N·ªôp & Ch·∫•m b√†i</h5><div class="relative flex-grow min-h-0"><canvas id="overview-submissionChart"></canvas></div></div>
                            <div class="bg-white p-4 rounded-xl shadow-lg flex flex-col h-72"><h5 class="text-center font-semibold text-slate-600 mb-2 flex-shrink-0">T·ªâ l·ªá Ch·∫•m b√†i</h5><div class="relative flex-grow min-h-0"><canvas id="overview-gradingChart"></canvas></div></div>
                            <div class="bg-white p-4 rounded-xl shadow-lg flex flex-col h-72"><h5 class="text-center font-semibold text-slate-600 mb-2 flex-shrink-0">Chuy√™n c·∫ßn</h5><div class="relative flex-grow min-h-0"><canvas id="overview-attendanceChart"></canvas></div></div>
                            <div class="bg-white p-4 rounded-xl shadow-lg flex flex-col h-72"><h5 class="text-center font-semibold text-slate-600 mb-2 flex-shrink-0">ƒêi·ªÉm K·ªπ nƒÉng TB</h5><div class="relative flex-grow min-h-0"><canvas id="overview-skillsChart"></canvas></div></div>
                        </div>
                    </div>
                    <p class="text-sm text-slate-500 mb-6">${filterMessage}</p>
                    ${tableOrMessage}
                </div>`;

                return { html, chartData };
            },
            lessons: (courseId) => {
                const courseLessons = lessons.filter(l => l.courseId === courseId).sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                return `
                 <div>
                     <h3 class="text-xl font-bold mb-4">Danh s√°ch b√†i h·ªçc</h3>
                     ${courseLessons.map(l => {
                         const hasHomework = homeworks.some(h => h.lessonId === l.id && h.title && h.description);
                         const homeworkButtonClass = hasHomework ? 'text-green-600 hover:text-green-800' : 'text-red-500 hover:text-red-700';
                         return `
                         <div class="p-3 bg-slate-50 rounded-lg mb-2 flex justify-between items-center">
                             <span class="font-medium">${l.title}</span>
                             <div class="space-x-4">
                                 <button class="manage-homework-btn ${homeworkButtonClass} text-sm" data-lesson-id="${l.id}"><i class="fas fa-tasks mr-1"></i>B√†i t·∫≠p</button>
                                 <button class="edit-lesson-btn text-gray-500 hover:text-blue-700 text-sm" data-lesson-id="${l.id}"><i class="fas fa-edit mr-1"></i>Ch·ªânh s·ª≠a</button>
                                 <button class="delete-lesson-btn text-red-500 hover:text-red-700 text-sm" data-lesson-id="${l.id}"><i class="fas fa-trash mr-1"></i>X√≥a</button>
                             </div>
                         </div>`;
                     }).join('') || '<p class="text-slate-500 text-sm">Ch∆∞a c√≥ b√†i h·ªçc n√†o.</p>'}
                 </div>
                 <div class="p-4 bg-slate-50 rounded-lg border border-dashed mt-6">
                     <h3 class="text-xl font-bold mb-3">Th√™m b√†i h·ªçc m·ªõi</h3>
                     <div class="space-y-3">
                         <input type="text" id="new-lesson-title" placeholder="Ti√™u ƒë·ªÅ b√†i h·ªçc" class="w-full p-2 border rounded-lg">
                         <input type="text" id="new-lesson-video" placeholder="Link video YouTube (t√πy ch·ªçn)" class="w-full p-2 border rounded-lg">
                         <textarea id="new-lesson-content" placeholder="N·ªôi dung b√†i h·ªçc" class="w-full p-2 border rounded-lg"></textarea>
                         <div>
                             <label class="block text-sm font-medium text-slate-600 mb-2">Ch·ªçn k·ªπ nƒÉng s·∫Ω d·∫°y trong b√†i h·ªçc:</label>
                             <div class="space-y-2">
                                 <label class="flex items-center">
                                     <input type="checkbox" class="lesson-skill-checkbox" value="reading" class="h-4 w-4"> 
                                     <span class="ml-2 text-sm">K·ªπ nƒÉng ƒê·ªçc</span>
                                 </label>
                                 <label class="flex items-center">
                                     <input type="checkbox" class="lesson-skill-checkbox" value="listening" class="h-4 w-4"> 
                                     <span class="ml-2 text-sm">K·ªπ nƒÉng Nghe</span>
                                 </label>
                                 <label class="flex items-center">
                                     <input type="checkbox" class="lesson-skill-checkbox" value="speaking" class="h-4 w-4"> 
                                     <span class="ml-2 text-sm">K·ªπ nƒÉng N√≥i</span>
                                 </label>
                                 <label class="flex items-center">
                                     <input type="checkbox" class="lesson-skill-checkbox" value="writing" class="h-4 w-4"> 
                                     <span class="ml-2 text-sm">K·ªπ nƒÉng Vi·∫øt</span>
                                 </label>
                             </div>
                         </div>
                         <button id="add-lesson-btn" data-course-id="${courseId}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Th√™m b√†i h·ªçc</button>
                     </div>
                 </div>
                `;
            },
            students: (courseId, enrolledStudents) => {
                 return `
                 <div class="flex justify-between items-center mb-6">
                     <div>
                         <h3 class="text-xl font-bold">Danh s√°ch h·ªçc sinh (${enrolledStudents.length})</h3>
                         <p class="text-sm text-slate-500">Ch·ªçn m·ªôt h·ªçc sinh ƒë·ªÉ xem chi ti·∫øt ti·∫øn ƒë·ªô.</p>
                     </div>
                 </div>
                 <div id="student-list-container">
                    ${renderStudentsAndProgressTab(enrolledStudents)}
                 </div>`;
            }
        };

        const renderStudentsAndProgressTab = (enrolledStudents) => {
            if (enrolledStudents.length === 0) {
                return '<p class="text-slate-500 text-center py-4">Ch∆∞a c√≥ h·ªçc sinh n√†o trong kh√≥a h·ªçc n√†y.</p>';
            }
            return `
                 <div class="space-y-3">
                 ${enrolledStudents.map(student => `
                     <div class="p-4 bg-slate-50 rounded-lg flex justify-between items-center cursor-pointer hover:bg-slate-100 transition-colors view-student-progress-btn" data-student-id="${student.id}">
                         <span class="font-semibold">${student.name}</span>
                         <i class="fas fa-chevron-right text-gray-400"></i>
                     </div>
                 `).join('')}
                 </div>`;
        };
        const renderStudentProgressView = (studentId, isRestoring = false) => {
            if (!isRestoring) {
                currentView = 'studentProgress';
            }
            currentStudentIdForProgress = studentId;
            const student = users.find(u => u.id === studentId);
            if (!student) {
                renderTeacherCourseManagement(currentCourseId);
                return;
            }

            const courseLessons = lessons.filter(l => l.courseId === currentCourseId).sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
            document.title = `Ti·∫øn ƒë·ªô: ${student.name}`;

            appContainer.innerHTML = `
                 <div class="w-full max-w-7xl mx-auto fade-in">
                     ${renderHeader(`Ch·ªânh s·ª≠a: ${student.name}`, true)}
                     <main class="bg-white p-6 md:p-8 mt-6 rounded-xl shadow-lg">
                         <p class="text-sm text-slate-500 mb-6">Nh·∫•n v√†o m·ªôt b√†i h·ªçc ƒë·ªÉ ch·ªânh s·ª≠a ƒëi·ªÉm, ƒëi·ªÉm danh v√† nh·∫≠n x√©t.</p>
                         <div class="space-y-4" id="progress-list-container" data-student-id="${studentId}">
                             ${renderProgressForStudent(studentId, courseLessons)}
                         </div>
                     </main>
                 </div>
            `;
        };

        const renderProgressForStudent = (studentId, courseLessons) => {
            if (courseLessons.length === 0) {
                return '<p class="text-slate-500 text-sm text-center py-4">Ch∆∞a c√≥ b√†i h·ªçc n√†o trong kh√≥a h·ªçc n√†y.</p>';
            }
            return courseLessons.map(lesson => {
                const progressRecord = progress.find(p => p.lessonId === lesson.id && p.studentId === studentId) || {};
                const { attendanceStatus, grade, submittedAt: submitted } = progressRecord;

                const presentClass = attendanceStatus === 'present' ? 'bg-blue-500 text-white' : 'bg-slate-200 text-slate-500';
                const absentExcusedClass = attendanceStatus === 'absent_excused' ? 'bg-yellow-500 text-white' : 'bg-slate-200 text-slate-500';
                const absentUnexcusedClass = attendanceStatus === 'absent_unexcused' ? 'bg-red-500 text-white' : 'bg-slate-200 text-slate-500';
                const lateClass = attendanceStatus === 'late' ? 'bg-orange-500 text-white' : 'bg-slate-200 text-slate-500';

                return `
                     <div class="p-4 border rounded-lg bg-white shadow-sm lesson-progress-summary hover:shadow-md hover:border-blue-500 transition-all cursor-pointer" data-lesson-id="${lesson.id}" data-student-id="${studentId}" role="button" tabindex="0">
                         <div class="flex flex-col sm:flex-row justify-between sm:items-start">
                             <div>
                                 <p class="font-medium">${lesson.title}</p>
                                 ${submitted ? '<p class="text-xs text-green-600 font-semibold mt-1">ƒê√É N·ªòP B√ÄI</p>' : '<p class="text-xs text-slate-400 mt-1">Ch∆∞a n·ªôp b√†i</p>'}
                             </div>
                             <div class="flex items-center space-x-2 mt-3 sm:mt-0 flex-shrink-0 flex-wrap gap-2">
                                 <span class="text-xs px-2 py-1 border rounded-full ${presentClass}">C√≥ m·∫∑t</span>
                                 <span class="text-xs px-2 py-1 border rounded-full ${absentExcusedClass}">V·∫Øng m·∫∑t c√≥ ph√©p</span>
                                 <span class="text-xs px-2 py-1 border rounded-full ${absentUnexcusedClass}">V·∫Øng m·∫∑t kh√¥ng ph√©p</span>
                                 <span class="text-xs px-2 py-1 border rounded-full ${lateClass}">Kh√¥ng ƒë√∫ng gi·ªù</span>
                             </div>
                         </div>
                         <div class="mt-4 pt-4 border-t flex justify-between items-center">
                             <div>
                                 <span class="text-sm font-medium text-slate-600">ƒêi·ªÉm: </span>
                                 <span class="font-bold text-lg text-blue-600">${grade ?? '--'}</span>
                             </div>
                             <div class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
                                 Ch·ªânh s·ª≠a <i class="fas fa-edit ml-1"></i>
                             </div>
                         </div>
                     </div>
                `;
            }).join('');
        };
        
        const renderEditProgressModal = (studentId, lessonId) => {
            const student = users.find(u => u.id === studentId);
            const lesson = lessons.find(l => l.id === lessonId);
            if (!student || !lesson) return;

            const progressRecord = progress.find(p => p.lessonId === lesson.id && p.studentId === student.id) || {};
            const { attendanceStatus = '', comment = '' } = progressRecord;
            const course = courses.find(c => c.id === lesson.courseId);

            const modalContent = `
             <div class="bg-white w-full max-w-lg md:max-w-2xl rounded-xl shadow-lg p-8 fade-in max-h-[85vh] overflow-y-auto">
                 <h2 class="text-2xl font-bold mb-2">C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô h·ªçc t·∫≠p</h2>
                 <p class="text-slate-600 mb-8">H·ªçc sinh: <strong class="font-semibold">${student.name}</strong></p>
                 
                 <div class="space-y-8">
                      <div>
                         <p class="block text-sm font-medium text-slate-600 mb-2">B√†i h·ªçc: <strong class="font-semibold text-slate-800">${lesson.title}</strong></p>
                     </div>

                     <div>
                         <label class="block text-sm font-medium text-slate-600 mb-2">ƒêi·ªÉm danh:</label>
                         <div class="flex flex-wrap items-center gap-2 attendance-btn-group">
                             <button data-status="present" class="attendance-btn text-sm px-3 py-1 border rounded-full ${attendanceStatus === 'present' ? 'attendance-btn-active' : 'bg-white hover:bg-slate-100'}">C√≥ m·∫∑t</button>
                             <button data-status="absent_excused" class="attendance-btn text-sm px-3 py-1 border rounded-full ${attendanceStatus === 'absent_excused' ? 'attendance-btn-active bg-yellow-500' : 'bg-white hover:bg-slate-100'}">V·∫Øng m·∫∑t c√≥ ph√©p</button>
                             <button data-status="absent_unexcused" class="attendance-btn text-sm px-3 py-1 border rounded-full ${attendanceStatus === 'absent_unexcused' ? 'attendance-btn-active bg-red-500' : 'bg-white hover:bg-slate-100'}">V·∫Øng m·∫∑t kh√¥ng ph√©p</button>
                             <button data-status="late" class="attendance-btn text-sm px-3 py-1 border rounded-full ${attendanceStatus === 'late' ? 'attendance-btn-active bg-orange-500' : 'bg-white hover:bg-slate-100'}">Kh√¥ng ƒë√∫ng gi·ªù</button>
                         </div>
                     </div>

                     ${course?.submissionFolderUrl ? `
                     <div>
                         <label class="block text-sm font-medium text-slate-600 mb-2">B√†i t·∫≠p ƒë√£ n·ªôp:</label>
                         <a href="${course.submissionFolderUrl}" target="_blank" class="inline-flex items-center bg-yellow-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors">
                             <i class="fab fa-google-drive mr-2"></i>
                             M·ªü th∆∞ m·ª•c b√†i t·∫≠p c·ªßa kh√≥a h·ªçc
                         </a>
                     </div>
                     ` : ''}

                     <div class="space-y-6">
                         <div>
                             <label class="block text-sm font-medium text-slate-600 mb-2">ƒêi·ªÉm s·ªë:</label>
                             <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="grade-inputs">
                                 ${lesson.skillsToTeach?.includes('reading') ? `
                                 <div>
                                     <label for="edit-reading-score" class="block text-xs text-slate-500">ƒê·ªçc</label>
                                     <input type="number" id="edit-reading-score" class="score-input w-full p-2 border rounded text-center font-bold" value="${progressRecord.grades?.reading ?? ''}">
                                 </div>
                                 ` : `<div style="display: none;"><input type="hidden" id="edit-reading-score" value="0"></div>`}
                                 ${lesson.skillsToTeach?.includes('listening') ? `
                                 <div>
                                     <label for="edit-listening-score" class="block text-xs text-slate-500">Nghe</label>
                                     <input type="number" id="edit-listening-score" class="score-input w-full p-2 border rounded text-center font-bold" value="${progressRecord.grades?.listening ?? ''}">
                                 </div>
                                 ` : `<div style="display: none;"><input type="hidden" id="edit-listening-score" value="0"></div>`}
                                 ${lesson.skillsToTeach?.includes('speaking') ? `
                                 <div>
                                     <label for="edit-speaking-score" class="block text-xs text-slate-500">N√≥i</label>
                                     <input type="number" id="edit-speaking-score" class="score-input w-full p-2 border rounded text-center font-bold" value="${progressRecord.grades?.speaking ?? ''}">
                                 </div>
                                 ` : `<div style="display: none;"><input type="hidden" id="edit-speaking-score" value="0"></div>`}
                                 ${lesson.skillsToTeach?.includes('writing') ? `
                                 <div>
                                     <label for="edit-writing-score" class="block text-xs text-slate-500">Vi·∫øt</label>
                                     <input type="number" id="edit-writing-score" class="score-input w-full p-2 border rounded text-center font-bold" value="${progressRecord.grades?.writing ?? ''}">
                                 </div>
                                 ` : `<div style="display: none;"><input type="hidden" id="edit-writing-score" value="0"></div>`}
                             </div>
                             <div class="mt-4">
                                 <span class="text-sm font-medium text-slate-600">ƒêi·ªÉm trung b√¨nh: </span>
                                 <span id="average-score-display" class="font-bold text-2xl text-blue-600">--</span>
                             </div>
                         </div>
                         <div>
                             <label for="edit-comment-input" class="block text-sm font-medium text-slate-600 mb-1">Nh·∫≠n x√©t c·ªßa gi√°o vi√™n:</label>
                             <textarea id="edit-comment-input" class="w-full p-3 border rounded-lg text-sm h-40" placeholder="Nh·∫≠p nh·∫≠n x√©t chi ti·∫øt‚Ä¶">${comment}</textarea>
                         </div>
                     </div>
                 </div>

                 <div class="mt-8 flex justify-end space-x-3">
                     <button class="cancel-modal-btn px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Hu·ª∑</button>
                     <button id="save-progress-btn" data-student-id="${studentId}" data-lesson-id="${lessonId}" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">L∆∞u thay ƒë·ªïi</button>
                 </div>
             </div>
            `;
            showModal(modalContent);
            calculateAverageScore();
        };

        const renderEditLessonModal = (lessonId) => {
            const lesson = lessons.find(l => l.id === lessonId);
            if (!lesson) return;
            const skillsToTeach = lesson.skillsToTeach || [];
            const modalContent = `<div class="bg-white w-full max-w-lg rounded-xl shadow-lg p-6 fade-in"><h2 class="text-2xl font-bold mb-4">Ch·ªânh s·ª≠a b√†i h·ªçc</h2><div class="space-y-4"><div><label for="edit-lesson-title" class="block text-sm font-medium text-slate-600 mb-1">Ti√™u ƒë·ªÅ b√†i h·ªçc:</label><input type="text" id="edit-lesson-title" class="w-full p-2 border rounded-lg" value="${lesson.title}"></div><div><label for="edit-lesson-video" class="block text-sm font-medium text-slate-600 mb-1">Link video YouTube:</label><input type="text" id="edit-lesson-video" class="w-full p-2 border rounded-lg" value="${lesson.videoUrl || ''}"></div><div><label for="edit-lesson-content" class="block text-sm font-medium text-slate-600 mb-1">N·ªôi dung b√†i h·ªçc:</label><textarea id="edit-lesson-content" class="w-full p-2 border rounded-lg h-32">${lesson.content}</textarea></div><div><label class="block text-sm font-medium text-slate-600 mb-2">K·ªπ nƒÉng s·∫Ω d·∫°y trong b√†i h·ªçc:</label><div class="space-y-2"><label class="flex items-center"><input type="checkbox" class="edit-lesson-skill-checkbox" value="reading" ${skillsToTeach.includes('reading') ? 'checked' : ''} class="h-4 w-4"><span class="ml-2 text-sm">K·ªπ nƒÉng ƒê·ªçc</span></label><label class="flex items-center"><input type="checkbox" class="edit-lesson-skill-checkbox" value="listening" ${skillsToTeach.includes('listening') ? 'checked' : ''} class="h-4 w-4"><span class="ml-2 text-sm">K·ªπ nƒÉng Nghe</span></label><label class="flex items-center"><input type="checkbox" class="edit-lesson-skill-checkbox" value="speaking" ${skillsToTeach.includes('speaking') ? 'checked' : ''} class="h-4 w-4"><span class="ml-2 text-sm">K·ªπ nƒÉng N√≥i</span></label><label class="flex items-center"><input type="checkbox" class="edit-lesson-skill-checkbox" value="writing" ${skillsToTeach.includes('writing') ? 'checked' : ''} class="h-4 w-4"><span class="ml-2 text-sm">K·ªπ nƒÉng Vi·∫øt</span></label></div></div></div><div class="mt-6 flex justify-end space-x-3"><button class="cancel-modal-btn px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Hu·ª∑</button><button id="save-lesson-btn" data-lesson-id="${lessonId}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">L∆∞u thay ƒë·ªïi</button></div></div>`;
            return modalContent;
        };
        const renderHomeworkModal = (lessonId) => {
            const homework = homeworks.find(h => h.lessonId === lessonId);
            const modalContent = `<div class="bg-white w-full max-w-lg rounded-xl shadow-lg p-6 fade-in"><h2 class="text-2xl font-bold mb-4">${homework ? 'Ch·ªânh s·ª≠a' : 'T·∫°o m·ªõi'} B√†i t·∫≠p</h2><div class="space-y-4"><div><label for="homework-title" class="block text-sm font-medium text-slate-600 mb-1">Ti√™u ƒë·ªÅ b√†i t·∫≠p:</label><input type="text" id="homework-title" class="w-full p-2 border rounded-lg" value="${homework?.title || ''}"></div><div><label for="homework-desc" class="block text-sm font-medium text-slate-600 mb-1">M√¥ t·∫£ / Y√™u c·∫ßu:</label><textarea id="homework-desc" class="w-full p-2 border rounded-lg h-24">${homework?.description || ''}</textarea></div></div><div class="mt-6 flex justify-between"><div>${homework ? `<button id="delete-homework-btn" data-homework-id="${homework.id}" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Xo√° b√†i t·∫≠p</button>` : ''}</div><div class="flex space-x-3"><button class="cancel-modal-btn px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Hu·ª∑</button><button id="save-homework-btn" data-lesson-id="${lessonId}" data-homework-id="${homework?.id || ''}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">L∆∞u</button></div></div></div>`;
            return modalContent;
        };

        const renderStudentDashboard = () => {
             if (currentView !== 'course' && currentView !== 'lesson' && currentView !== 'myProgress') {
                 currentView = 'dashboard';
             }
             document.title = "Student Dashboard | H·ªçc Ti·∫øng Trung C√πng Th∆∞";
            const myCourseIds = enrollments.filter(e => e.studentId === currentUser.id).map(e => e.courseId);
            const myCourses = courses.filter(c => myCourseIds.includes(c.id));
            appContainer.innerHTML = `<div class="w-full max-w-7xl mx-auto fade-in">${renderHeader('C√°c kho√° h·ªçc c·ªßa t√¥i')}<main class="mt-6"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${myCourses.length > 0 ? myCourses.map(c => renderCourseCard(c)).join('') : '<p class="text-slate-500 md:col-span-3 text-center py-8">B·∫°n ch∆∞a ƒë∆∞·ª£c ghi danh v√†o kho√° h·ªçc n√†o.</p>'}</div></main></div>`;
        };
        const renderCourseCard = (course) => {
            const teacher = users.find(u => u.id === course.createdBy);
            const courseLessons = lessons.filter(l => l.courseId === course.id);
            const completedLessons = progress.filter(p => p.studentId === currentUser.id && courseLessons.some(l => l.id === p.lessonId) && p.submittedAt).length;
            const progressPercentage = courseLessons.length > 0 ? Math.round((completedLessons / courseLessons.length) * 100) : 0;
            return `
             <div class="bg-white rounded-xl overflow-hidden shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 flex flex-col">
                 <div class="p-6 flex-grow">
                     <p class="text-sm text-blue-500 font-semibold">${teacher?.name || 'Unknown Teacher'}</p>
                     <h3 class="font-bold text-xl mt-1 text-slate-800">${course.title}</h3>
                     <p class="text-sm text-slate-600 mt-2 h-10">${course.description}</p>
                 </div>
                 <div class="px-6 pb-6">
                     <div class="flex justify-between items-center mb-2">
                         <span class="text-xs font-semibold text-slate-500">TI·∫æN ƒê·ªò</span>
                         <span class="text-xs font-bold text-blue-600">${progressPercentage}%</span>
                     </div>
                     <div class="w-full bg-slate-200 rounded-full h-2">
                         <div class="bg-blue-600 h-2 rounded-full" style="width: ${progressPercentage}%"></div>
                     </div>
                 </div>
                 <div class="bg-slate-50 p-4">
                     <button class="w-full text-center font-semibold text-blue-600 hover:text-blue-800 view-course-btn transition-colors" data-id="${course.id}">V√†o h·ªçc <i class="fas fa-arrow-right ml-2"></i></button>
                 </div>
             </div>`;
        };
        const renderStudentCourseView = (courseId, isRestoring = false) => {
            if (!isRestoring) {
                currentView = 'course';
            }
            currentCourseId = courseId;
            const course = courses.find(c => c.id === courseId);
            if (!course) return renderStudentDashboard(); // Fallback
            const courseLessons = lessons.filter(l => l.courseId === courseId).sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
            document.title = course.title;
            appContainer.innerHTML = `<div class="w-full max-w-7xl mx-auto fade-in">${renderHeader(course.title, true)}<div class="bg-white p-8 mt-6 rounded-xl shadow-lg">
                 <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                     <div>
                         <h2 class="text-2xl font-bold">N·ªôi dung kho√° h·ªçc</h2>
                         <p class="text-slate-600">${course.description}</p>
                     </div>
                     <div class="flex-shrink-0 flex items-center space-x-2">
                          ${course.submissionFolderUrl ? `<a href="${course.submissionFolderUrl}" target="_blank" class="inline-flex items-center bg-yellow-50 text-yellow-700 font-semibold px-4 py-2 rounded-lg hover:bg-yellow-100 transition-colors"><i class="fab fa-google-drive mr-2"></i>Th∆∞ m·ª•c l·ªõp h·ªçc</a>` : ''}
                         <button class="view-my-progress-btn bg-blue-50 text-blue-600 font-semibold px-4 py-2 rounded-lg hover:bg-blue-100 transition-colors" data-course-id="${courseId}">
                             <i class="fas fa-chart-line mr-2"></i>Xem ti·∫øn ƒë·ªô
                         </button>
                     </div>
                 </div>

                 <div class="space-y-3">${courseLessons.map((lesson, index) => { 
                     const progressRecord = progress.find(p => p.lessonId === lesson.id && p.studentId === currentUser.id);
                     const isSubmitted = !!progressRecord?.submittedAt;
                     
                     return `<div class="p-4 bg-slate-100 rounded-lg flex justify-between items-center"><div class="flex items-center"><span class="mr-4 font-bold text-slate-400 text-lg">${index + 1}</span>${isSubmitted ? '<i class="fas fa-check-circle text-green-500 mr-3"></i>' : '<i class="far fa-circle text-blue-500 mr-3"></i>'}<span class="font-medium ${isSubmitted ? 'text-slate-500' : ''}">${lesson.title}</span></div><button class="view-lesson-btn bg-white text-blue-600 px-4 py-1 rounded-full border border-blue-200 font-semibold text-sm hover:bg-blue-50" data-lesson-id="${lesson.id}">${isSubmitted ? 'Xem l·∫°i' : 'B·∫Øt ƒë·∫ßu'}</button></div>` 
                 }).join('') || '<p class="text-slate-500 text-center py-4">Ch∆∞a c√≥ b√†i h·ªçc n√†o trong kh√≥a h·ªçc n√†y.</p>'}</div></div></div>`;
        };
        const renderLessonView = (lessonId, isRestoring = false) => {
            if (!isRestoring && currentView !== 'lesson') {
                currentView = 'lesson';
            }
            currentLessonId = lessonId;
            const lesson = lessons.find(l => l.id === lessonId);
            if (!lesson) return renderStudentCourseView(currentCourseId);
            const course = courses.find(c => c.id === lesson.courseId);
            const homework = homeworks.find(h => h.lessonId === lessonId);
            document.title = lesson.title;
            const progressRecord = progress.find(p => p.lessonId === lesson.id && p.studentId === currentUser.id);
            const hasSubmitted = progressRecord?.submittedAt;
            const embedUrl = getYoutubeEmbedUrl(lesson.videoUrl);

            appContainer.innerHTML = `<div class="w-full max-w-7xl mx-auto fade-in">${renderHeader(lesson.title, true)}<div class="bg-white p-6 md:p-8 mt-6 rounded-xl shadow-lg">${embedUrl ? `<div class="video-container shadow-md mb-8"><iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe></div>` : ''}<h2 class="text-3xl font-bold mb-4 text-slate-800">N·ªôi dung b√†i h·ªçc</h2><div class="prose max-w-none text-slate-700 mb-8 whitespace-pre-wrap">${lesson.content || '<p><em>Ch∆∞a c√≥ n·ªôi dung cho b√†i h·ªçc n√†y.</em></p>'}</div>
            
            ${homework ? `<hr class="my-8"><div class="p-6 bg-slate-50 rounded-lg"><h2 class="text-2xl font-bold mb-2">B√†i t·∫≠p: ${homework.title}</h2><p class="text-slate-600 mb-6 whitespace-pre-wrap">${homework.description}</p>${currentUser.role === 'student' ? (hasSubmitted ? `<div class="p-4 border rounded-lg ${progressRecord.grade !== null && progressRecord.grade !== undefined ? 'bg-green-50 border-green-300' : 'bg-blue-50 border-blue-200'}"><div class="flex justify-between items-start"><div class="flex items-start"><i class="fas fa-check-circle ${progressRecord.grade !== null && progressRecord.grade !== undefined ? 'text-green-600' : 'text-blue-600'} mr-3 fa-lg mt-1"></i><div><p class="font-bold ${progressRecord.grade !== null && progressRecord.grade !== undefined ? 'text-green-800' : 'text-blue-800'}">B·∫°n ƒë√£ n·ªôp b√†i.</p><p class="mt-2"><strong>ƒêi·ªÉm:</strong> ${progressRecord.grade !== null && progressRecord.grade !== undefined ? `<span class="font-bold text-lg">${progressRecord.grade}</span>` : 'Ch∆∞a ƒë∆∞·ª£c ch·∫•m'}</p></div></div>${(progressRecord.grade === null || progressRecord.grade === undefined) ? `<button class="cancel-submission-btn bg-gray-200 text-gray-700 text-xs font-semibold px-3 py-1 rounded-full hover:bg-gray-300" data-lesson-id="${lesson.id}">H·ªßy x√°c nh·∫≠n</button>` : ''}</div>${progressRecord.comment ? `<div class="border-t pt-3 mt-3"><p class="font-semibold text-slate-700">Nh·∫≠n x√©t c·ªßa gi√°o vi√™n:</p><p class="text-slate-600 whitespace-pre-wrap mt-1">${progressRecord.comment}</p></div>` : ''}</div>` : `<div class="space-y-4"><div class="p-4 border-l-4 border-blue-500 bg-blue-50"><p class="font-bold text-blue-800">H∆∞·ªõng d·∫´n n·ªôp b√†i</p><ol class="list-decimal list-inside text-sm text-blue-700 space-y-1 mt-2"><li>Nh·∫•n n√∫t <strong class="font-semibold">"M·ªü th∆∞ m·ª•c l·ªõp h·ªçc"</strong>.</li><li>Trong th∆∞ m·ª•c ƒë√≥, t·∫°o m·ªôt th∆∞ m·ª•c m·ªõi v·ªõi t√™n: <strong class="font-semibold">${currentUser.name} - ${lesson.title}</strong>.</li><li>T·∫£i t·∫•t c·∫£ c√°c file b√†i l√†m c·ªßa b·∫°n v√†o th∆∞ m·ª•c v·ª´a t·∫°o.</li><li>Quay l·∫°i ƒë√¢y v√† nh·∫•n n√∫t <strong class="font-semibold">"X√°c nh·∫≠n ƒë√£ n·ªôp b√†i"</strong>.</li></ol></div><div class="flex items-center space-x-4"><a href="${course?.submissionFolderUrl || '#'}" target="_blank" class="inline-block bg-yellow-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors ${!course?.submissionFolderUrl ? 'opacity-50 cursor-not-allowed' : ''}"><i class="fab fa-google-drive mr-2"></i>M·ªü th∆∞ m·ª•c l·ªõp h·ªçc</a><button class="confirm-submission-btn bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700" data-lesson-id="${lesson.id}"><i class="fas fa-check-circle mr-2"></i>X√°c nh·∫≠n ƒë√£ n·ªôp b√†i</button></div></div>`) : ''}</div>` : ''}
            
            </div></div>`;
        };

        const generateStudentProgressReport = (studentId, courseId) => {
            const course = courses.find(c => c.id === courseId);
            if (!course) return { html: '', chartData: {} };

            const courseLessons = lessons.filter(l => l.courseId === courseId);
            const lessonsWithHomework = courseLessons.filter(l => homeworks.some(h => h.lessonId === l.id));
            const studentProgress = progress.filter(p => p.studentId === studentId && courseLessons.some(l => l.id === p.lessonId));

            const totalSubmissions = studentProgress.filter(p => p.submittedAt && lessonsWithHomework.some(l => l.id === p.lessonId)).length;
            const totalGraded = studentProgress.filter(p => p.submittedAt && p.grade != null && lessonsWithHomework.some(l => l.id === p.lessonId)).length;
            const totalPossibleSubmissions = lessonsWithHomework.length;
            
            const totalPresent = studentProgress.filter(p => p.attendanceStatus === 'present').length;
            const totalLate = studentProgress.filter(p => p.attendanceStatus === 'late').length;
            const totalAbsentExcused = studentProgress.filter(p => p.attendanceStatus === 'absent_excused').length;
            const totalAbsentUnexcused = studentProgress.filter(p => p.attendanceStatus === 'absent_unexcused').length;
            const totalAttendanceSlots = courseLessons.length;
            const totalRecorded = totalPresent + totalLate + totalAbsentExcused + totalAbsentUnexcused;
            const totalNotRecorded = totalAttendanceSlots - totalRecorded;

            // Calculate skill averages for this student
            // Sum all grades from graded work only (grade != null)
            const skillTotals = { reading: 0, listening: 0, speaking: 0, writing: 0 };
            let gradedCount = 0;
            lessonsWithHomework.forEach(lesson => {
                const progressRecord = studentProgress.find(p => p.lessonId === lesson.id && p.submittedAt && p.grade != null);
                if (progressRecord) {
                    skillTotals.reading += progressRecord.grades?.reading ?? 0;
                    skillTotals.listening += progressRecord.grades?.listening ?? 0;
                    skillTotals.speaking += progressRecord.grades?.speaking ?? 0;
                    skillTotals.writing += progressRecord.grades?.writing ?? 0;
                    gradedCount++;
                }
            });
            
            const readingAvg = gradedCount > 0 ? (skillTotals.reading / gradedCount).toFixed(1) : '--';
            const listeningAvg = gradedCount > 0 ? (skillTotals.listening / gradedCount).toFixed(1) : '--';
            const speakingAvg = gradedCount > 0 ? (skillTotals.speaking / gradedCount).toFixed(1) : '--';
            const writingAvg = gradedCount > 0 ? (skillTotals.writing / gradedCount).toFixed(1) : '--';
            
            // For backward compatibility with existing code
            const readingScores = [readingAvg === '--' ? 0 : parseFloat(readingAvg)];
            const listeningScores = [listeningAvg === '--' ? 0 : parseFloat(listeningAvg)];
            const speakingScores = [speakingAvg === '--' ? 0 : parseFloat(speakingAvg)];
            const writingScores = [writingAvg === '--' ? 0 : parseFloat(writingAvg)];
            const calculateAverage = (scores) => scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : 0;
            
            
            const chartData = {
                submission: { labels: ['ƒê√£ n·ªôp', 'Ch∆∞a n·ªôp'], datasets: [{ data: [totalSubmissions, totalPossibleSubmissions > totalSubmissions ? totalPossibleSubmissions - totalSubmissions : 0], backgroundColor: ['#3b82f6', '#e2e8f0'] }] },
                grading: { labels: ['ƒê√£ ch·∫•m', 'Ch∆∞a ch·∫•m'], datasets: [{ data: [totalGraded, totalSubmissions - totalGraded], backgroundColor: ['#22c55e', '#facc15'] }] },
                attendance: { labels: ['C√≥ m·∫∑t', 'ƒêi tr·ªÖ', 'V·∫Øng c√≥ ph√©p', 'V·∫Øng kh√¥ng ph√©p', 'Ch∆∞a ƒëi·ªÉm danh'], datasets: [{ data: [totalPresent, totalLate, totalAbsentExcused, totalAbsentUnexcused, totalNotRecorded], backgroundColor: ['#22c55e', '#f97316', '#facc15', '#ef4444', '#e2e8f0'] }] },
                skills: { labels: ['ƒê·ªçc', 'Nghe', 'N√≥i', 'Vi·∫øt'], datasets: [{ label: 'ƒêi·ªÉm trung b√¨nh', data: [readingAvg === '--' ? 0 : readingAvg, listeningAvg === '--' ? 0 : listeningAvg, speakingAvg === '--' ? 0 : speakingAvg, writingAvg === '--' ? 0 : writingAvg], backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgba(59, 130, 246, 1)', pointBackgroundColor: 'rgba(59, 130, 246, 1)' }] }
            };

            const progressHTML = courseLessons.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)).map(lesson => {
                const progressRecord = studentProgress.find(p => p.lessonId === lesson.id) || {};
                const { attendanceStatus, grade, submittedAt: submitted } = progressRecord;
                
                const attendanceMap = {
                    present: { text: 'C√≥ m·∫∑t', class: 'bg-blue-500 text-white' },
                    absent_excused: { text: 'V·∫Øng c√≥ ph√©p', class: 'bg-yellow-500 text-white' },
                    absent_unexcused: { text: 'V·∫Øng kh√¥ng ph√©p', class: 'bg-red-500 text-white' },
                    late: { text: 'Kh√¥ng ƒë√∫ng gi·ªù', class: 'bg-orange-500 text-white' }
                };
                const attendanceInfo = attendanceMap[attendanceStatus] || { text: 'Ch∆∞a ƒëi·ªÉm danh', class: 'bg-slate-200 text-slate-500' };

                return `
                     <div class="p-4 border rounded-lg bg-white shadow-sm">
                         <div class="flex flex-col sm:flex-row justify-between sm:items-start mb-4">
                             <div>
                                 <p class="font-medium text-lg">${lesson.title}</p>
                                 ${submitted ? '<p class="text-xs text-green-600 font-semibold mt-1">ƒê√É N·ªòP B√ÄI</p>' : '<p class="text-xs text-slate-400 mt-1">Ch∆∞a n·ªôp b√†i</p>'}
                             </div>
                             <div class="mt-3 sm:mt-0">
                                 <span class="text-sm font-medium">ƒêi·ªÉm danh: </span>
                                 <span class="text-sm px-3 py-1 border rounded-full ${attendanceInfo.class}">${attendanceInfo.text}</span>
                             </div>
                         </div>
                         
                         <div class="border-t pt-4">
                             <div class="grid grid-cols-2 md:grid-cols-5 gap-4 items-center">
                                 <div class="col-span-2 md:col-span-4">
                                     <p class="font-semibold text-slate-700 mb-2">ƒêi·ªÉm chi ti·∫øt:</p>
                                     <div class="grid grid-cols-2 gap-3 text-sm">
                                         <p><span class="text-slate-500">ƒê·ªçc:</span> <strong class="text-slate-800">${progressRecord.grades?.reading ?? '--'}</strong></p>
                                         <p><span class="text-slate-500">Nghe:</span> <strong class="text-slate-800">${progressRecord.grades?.listening ?? '--'}</strong></p>
                                         <p><span class="text-slate-500">N√≥i:</span> <strong class="text-slate-800">${progressRecord.grades?.speaking ?? '--'}</strong></p>
                                         <p><span class="text-slate-500">Vi·∫øt:</span> <strong class="text-slate-800">${progressRecord.grades?.writing ?? '--'}</strong></p>
                                     </div>
                                 </div>
                                 <div class="text-center">
                                     <p class="text-sm font-medium text-slate-600">ƒêi·ªÉm TB</p>
                                     <p class="font-bold text-3xl text-blue-600">${grade ?? '--'}</p>
                                 </div>
                             </div>
                         </div>

                         ${progressRecord.comment ? `
                         <div class="mt-4 pt-4 border-t">
                              <p class="font-semibold text-slate-700">Nh·∫≠n x√©t c·ªßa gi√°o vi√™n:</p>
                              <p class="text-slate-600 whitespace-pre-wrap mt-1 bg-slate-50 p-3 rounded-md">${progressRecord.comment}</p>
                         </div>
                         ` : ''}
                     </div>
                `;
            }).join('');
            
            // Calculate overall average score from all graded submissions
            const allGradedRecords = studentProgress.filter(p => p.submittedAt && p.grade != null && lessonsWithHomework.some(l => l.id === p.lessonId));
            const allGrades = allGradedRecords.map(p => parseFloat(p.grade));
            const overallAverage = allGrades.length > 0 ? (allGrades.reduce((a, b) => a + b, 0) / allGrades.length).toFixed(1) : '--';
            
            const fullHTML = `
                <div class="p-6 bg-gradient-to-br from-slate-50 to-blue-50 rounded-xl shadow-lg mb-6 border border-blue-100">
                    <h3 class="text-xl font-bold mb-6 text-slate-800">üìä T·ªïng quan k·∫øt qu·∫£ h·ªçc t·∫≠p</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                        <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-blue-500">
                            <p class="text-sm font-medium text-slate-600 mb-2">ƒêi·ªÉm ƒê√°nh Gi√° NƒÉng L·ª±c</p>
                            <p class="text-3xl font-bold text-blue-600">${overallAverage}</p>
                            <p class="text-xs text-slate-500 mt-2">T·ª´ ${allGradedRecords.length} b√†i ƒë√£ ch·∫•m</p>
                        </div>
                        
                        <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-green-500">
                            <p class="text-sm font-medium text-slate-600 mb-2">ƒê·ªçc</p>
                            <p class="text-3xl font-bold text-green-600">${readingAvg}</p>
                            <p class="text-xs text-slate-500 mt-2">${gradedCount > 0 ? 'Trung b√¨nh' : 'Ch∆∞a ƒë√°nh gi√°'}</p>
                        </div>
                        
                        <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-purple-500">
                            <p class="text-sm font-medium text-slate-600 mb-2">Nghe</p>
                            <p class="text-3xl font-bold text-purple-600">${listeningAvg}</p>
                            <p class="text-xs text-slate-500 mt-2">${gradedCount > 0 ? 'Trung b√¨nh' : 'Ch∆∞a ƒë√°nh gi√°'}</p>
                        </div>
                        
                        <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-orange-500">
                            <p class="text-sm font-medium text-slate-600 mb-2">N√≥i</p>
                            <p class="text-3xl font-bold text-orange-600">${speakingAvg}</p>
                            <p class="text-xs text-slate-500 mt-2">${gradedCount > 0 ? 'Trung b√¨nh' : 'Ch∆∞a ƒë√°nh gi√°'}</p>
                        </div>
                        
                        <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-red-500">
                            <p class="text-sm font-medium text-slate-600 mb-2">Vi·∫øt</p>
                            <p class="text-3xl font-bold text-red-600">${writingAvg}</p>
                            <p class="text-xs text-slate-500 mt-2">${gradedCount > 0 ? 'Trung b√¨nh' : 'Ch∆∞a ƒë√°nh gi√°'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 bg-white rounded-xl shadow-lg mb-6">
                    <h3 class="text-xl font-bold mb-4">Bi·ªÉu ƒë·ªì th·ªëng k√™</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                         <div class="bg-slate-50 p-4 rounded-xl flex flex-col h-72"><h5 class="text-center font-semibold text-slate-600 mb-2 flex-shrink-0">T·ªâ l·ªá N·ªôp b√†i</h5><div class="relative flex-grow min-h-0"><canvas id="report-submissionChart"></canvas></div></div>
                         <div class="bg-slate-50 p-4 rounded-xl flex flex-col h-72"><h5 class="text-center font-semibold text-slate-600 mb-2 flex-shrink-0">T·ªâ l·ªá Ch·∫•m b√†i</h5><div class="relative flex-grow min-h-0"><canvas id="report-gradingChart"></canvas></div></div>
                         <div class="bg-slate-50 p-4 rounded-xl flex flex-col h-72"><h5 class="text-center font-semibold text-slate-600 mb-2 flex-shrink-0">Chuy√™n c·∫ßn</h5><div class="relative flex-grow min-h-0"><canvas id="report-attendanceChart"></canvas></div></div>
                         <div class="bg-slate-50 p-4 rounded-xl flex flex-col h-72"><h5 class="text-center font-semibold text-slate-600 mb-2 flex-shrink-0">ƒêi·ªÉm K·ªπ nƒÉng TB</h5><div class="relative flex-grow min-h-0"><canvas id="report-skillsChart"></canvas></div></div>
                    </div>
                </div>
                <h3 class="text-xl font-bold mb-4">Chi ti·∫øt t·ª´ng bu·ªïi h·ªçc</h3>
                <div class="space-y-4">${courseLessons.length > 0 ? progressHTML : '<p class="text-slate-500 text-center py-8">Ch∆∞a c√≥ b√†i h·ªçc n√†o trong kh√≥a h·ªçc n√†y.</p>'}</div>
            `;
            
            return { html: fullHTML, chartData };
        };

        const renderMyProgressView = (courseId, isRestoring = false) => {
            if (!isRestoring) {
                currentView = 'myProgress';
            }
            const course = courses.find(c => c.id === courseId);
            if (!course) return renderStudentDashboard();

            document.title = `Ti·∫øn ƒë·ªô c·ªßa t√¥i: ${course.title}`;
            const { html, chartData } = generateStudentProgressReport(currentUser.id, courseId);

            appContainer.innerHTML = `
                 <div class="w-full max-w-7xl mx-auto fade-in">
                     ${renderHeader(`Ti·∫øn ƒë·ªô c·ªßa t√¥i`, true)}
                     <main class="mt-6">
                         ${html}
                     </main>
                 </div>
            `;
            setTimeout(() => renderCharts(chartData, 'report-'), 50);
        };
        const renderTeacherStudentReportView = (studentId, courseId, isRestoring = false) => {
            if (!isRestoring) {
                currentView = 'studentReport';
            }
            currentStudentIdForProgress = studentId;
            const student = users.find(u => u.id === studentId);
            const course = courses.find(c => c.id === courseId);
            if (!student || !course) return renderTeacherCourseManagement(currentCourseId);

            document.title = `B√°o c√°o: ${student.name}`;
            const { html, chartData } = generateStudentProgressReport(studentId, courseId);

            appContainer.innerHTML = `
                 <div class="w-full max-w-7xl mx-auto fade-in">
                     <header class="w-full bg-white p-4 rounded-xl shadow-lg flex justify-between items-center sticky top-0 z-40 h-20">
                         <div class="flex items-center min-w-0">
                             <button class="back-btn mr-4 text-slate-500 hover:text-blue-600 transition-colors"><i class="fas fa-arrow-left fa-lg"></i></button>
                             <h1 class="text-xl md:text-2xl font-bold text-slate-800 truncate">B√°o c√°o: ${student.name}</h1>
                         </div>
                         <div class="flex items-center space-x-4">
                             <button id="edit-student-progress-btn" data-student-id="${studentId}" class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-600">
                                 <i class="fas fa-edit mr-2"></i>Ch·ªânh s·ª≠a
                             </button>
                         </div>
                     </header>
                     <main class="mt-6">
                        ${html}
                     </main>
                 </div>
            `;
            setTimeout(() => renderCharts(chartData, 'report-'), 50);
        };

        // ===================================================================================
        // KHU V·ª∞C 5: LOGIC CH√çNH V√Ä ƒêI·ªÄU H∆Ø·ªöNG
        // ===================================================================================
        const navigate = () => {
            if (!currentUser) {
                if (document.getElementById('loading-overlay').style.opacity === '0') {
                    renderLoginScreen();
                }
                return;
            }

            // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i v√†o localStorage (tr·ª´ khi l√† l·∫ßn kh√¥i ph·ª•c ƒë·∫ßu ti√™n)
            if (!isFirstNavigationAfterRestore && currentView !== 'login') {
                localStorage.setItem('currentView', currentView);
                localStorage.setItem('currentCourseId', currentCourseId || '');
                localStorage.setItem('currentLessonId', currentLessonId || '');
                localStorage.setItem('currentStudentIdForProgress', currentStudentIdForProgress || '');
                localStorage.setItem('currentActiveTab', currentActiveTab || 'overview');
            }

            // L∆∞u tr·∫°ng th√°i kh√¥i ph·ª•c ƒë·ªÉ c√°c render function bi·∫øt
            const isRestoring = isFirstNavigationAfterRestore;

            switch (currentUser.role) {
                case 'admin':
                    currentView = 'dashboard';
                    renderAdminDashboard();
                    break;
                case 'teacher':
                    if (currentView === 'studentReport') renderTeacherStudentReportView(currentStudentIdForProgress, currentCourseId, isRestoring);
                    else if (currentView === 'studentProgress') renderStudentProgressView(currentStudentIdForProgress, isRestoring);
                    else if (currentView === 'course') renderTeacherCourseManagement(currentCourseId, isRestoring);
                    else {
                        currentView = 'dashboard';
                        renderTeacherDashboard();
                    }
                    break;
                case 'student':
                    if (currentView === 'myProgress') renderMyProgressView(currentCourseId, isRestoring);
                    else if (currentView === 'lesson') renderLessonView(currentLessonId, isRestoring);
                    else if (currentView === 'course') renderStudentCourseView(currentCourseId, isRestoring);
                    else {
                        currentView = 'dashboard';
                        renderStudentDashboard();
                    }
                    break;
            }

            // Sau khi g·ªçi navigate l·∫ßn ƒë·∫ßu ti√™n t·ª´ kh√¥i ph·ª•c, ƒë·∫∑t c·ªù v·ªÅ false
            if (isFirstNavigationAfterRestore) {
                isFirstNavigationAfterRestore = false;
            }
        };

        const updateUI = () => {
            if (!currentUser) {
                return;
            }

            switch(currentView) {
                case 'dashboard':
                    if(currentUser.role === 'admin') renderAdminDashboard();
                    if(currentUser.role === 'teacher') renderTeacherDashboard();
                    if(currentUser.role === 'student') renderStudentDashboard();
                    break;
                case 'course':
                    if(currentUser.role === 'teacher') {
                        updateTeacherCourseTabs();
                    } else if (currentUser.role === 'student') {
                        renderStudentCourseView(currentCourseId, false);
                    }
                    break;
                case 'lesson': renderLessonView(currentLessonId, false); break;
                case 'studentProgress': renderStudentProgressView(currentStudentIdForProgress, false); break;
                case 'studentReport': renderTeacherStudentReportView(currentStudentIdForProgress, currentCourseId, false); break;
                case 'myProgress': renderMyProgressView(currentCourseId, false); break;
            }
        };

        // ===================================================================================
        // KHU V·ª∞C 6: B·ªò L·∫ÆNG NGHE S·ª∞ KI·ªÜN (EVENT LISTENERS)
        // ===================================================================================
        document.addEventListener('click', async (e) => {
            const target = e.target;
            
            if (target.closest('#login-btn')) {
                const username = document.getElementById('username-input').value;
                const password = document.getElementById('password-input').value;
                const userToLogin = users.find(u => u.username === username && u.password === password);
                if (userToLogin) {
                    localStorage.setItem('currentUserId', userToLogin.id);
                    currentUser = userToLogin;
                    navigate();
                    showToast(`Ch√†o m·ª´ng, ${currentUser.name}!`, 'success');
                } else {
                    const loginError = document.getElementById('login-error');
                    loginError.textContent = 'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c.';
                    loginError.classList.remove('hidden');
                }
            }
            if (target.closest('#logout-btn')) { 
                localStorage.removeItem('currentUserId');
                localStorage.removeItem('currentView');
                localStorage.removeItem('currentCourseId');
                localStorage.removeItem('currentLessonId');
                localStorage.removeItem('currentStudentIdForProgress');
                localStorage.removeItem('currentActiveTab');
                currentUser = null; 
                currentView = 'login'; 
                currentStudentIdForProgress = null;
                currentActiveTab = 'overview';
                overviewFilterLessonId = 'all';
                navigate(); 
            }
            if (target.closest('.back-btn')) {
                if (['lesson', 'studentProgress', 'myProgress', 'studentReport'].includes(currentView)) {
                    currentView = 'course';
                    currentStudentIdForProgress = null;
                } else if (currentView === 'course') {
                    currentView = 'dashboard';
                    overviewFilterLessonId = 'all';
                    currentActiveTab = 'overview'; // Reset tab khi quay v·ªÅ dashboard
                }
                navigate();
            }
            if (target.closest('.cancel-modal-btn') || target.closest('#cancel-edit-btn') || target === modalContainer || target.closest('#close-detail-modal-btn')) { 
                closeModal(); 
            }

            if (currentUser?.role === 'admin') {
                if (target.closest('#add-teacher-btn')) {
                    const name = document.getElementById('new-teacher-name').value;
                    const password = document.getElementById('new-teacher-password').value;
                    if (name && password) {
                        await addDoc(collection(db, "users"), { name: `GV. ${name}`, username: generateUsername(name, 'teacher'), role: 'teacher', password });
                        showToast('Th√™m gi√°o vi√™n th√†nh c√¥ng!', 'success');
                    } else { showToast('Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin', 'error'); }
                }
                if (target.closest('#add-student-btn')) {
                    const name = document.getElementById('new-student-name').value;
                    const password = document.getElementById('new-student-password').value;
                    const courseId = document.getElementById('admin-course-select').value;
                    if (name && password && courseId) {
                        const newStudentRef = await addDoc(collection(db, "users"), { name: `HS. ${name}`, username: generateUsername(name, 'student'), role: 'student', password });
                        await addDoc(collection(db, "enrollments"), { studentId: newStudentRef.id, courseId: courseId });
                        showToast('Th√™m v√† ghi danh h·ªçc sinh th√†nh c√¥ng!', 'success');
                    } else { showToast('Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin', 'error'); }
                }
                if (target.closest('.delete-user-btn')) {
                    const userId = target.closest('.delete-user-btn').dataset.id;
                    const userToDelete = users.find(u => u.id === userId);
                    if (userToDelete) showModal(renderPasswordConfirmModal(userId, userToDelete.name));
                }
                if (target.closest('#confirm-delete-btn')) {
                    const userId = target.closest('#confirm-delete-btn').dataset.userId;
                    const passwordInput = document.getElementById('admin-password-confirm').value;
                    if (passwordInput !== currentUser.password) {
                        document.getElementById('delete-error').textContent = 'M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c.';
                        document.getElementById('delete-error').classList.remove('hidden');
                        return;
                    }
                    const batch = writeBatch(db);
                    const userToDelete = users.find(u => u.id === userId);
                    if (!userToDelete) return;

                    if (userToDelete.role === 'teacher') {
                        const courseIdsToDelete = courses.filter(c => c.createdBy === userId).map(c => c.id);
                        if (courseIdsToDelete.length > 0) {
                            const lessonIdsToDelete = lessons.filter(l => courseIdsToDelete.includes(l.courseId)).map(l => l.id);
                            progress.filter(p => lessonIdsToDelete.includes(p.lessonId)).forEach(p => batch.delete(doc(db, "progress", p.id)));
                            homeworks.filter(h => lessonIdsToDelete.includes(h.lessonId)).forEach(h => batch.delete(doc(db, "homeworks", h.id)));
                            lessons.filter(l => courseIdsToDelete.includes(l.courseId)).forEach(l => batch.delete(doc(db, "lessons", l.id)));
                            enrollments.filter(e => courseIdsToDelete.includes(e.courseId)).forEach(e => batch.delete(doc(db, "enrollments", e.id)));
                            courses.filter(c => c.createdBy === userId).forEach(c => batch.delete(doc(db, "courses", c.id)));
                        }
                    }
                    if (userToDelete.role === 'student') {
                        enrollments.filter(e => e.studentId === userId).forEach(e => batch.delete(doc(db, "enrollments", e.id)));
                        progress.filter(p => p.studentId === userId).forEach(p => batch.delete(doc(db, "progress", p.id)));
                    }
                    batch.delete(doc(db, "users", userId));
                    await batch.commit();
                    closeModal();
                    showToast('X√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng!', 'success');
                }
                if (target.closest('.edit-student-btn')) { showModal(renderEditStudentModal(target.closest('.edit-student-btn').dataset.id)); }
                if (target.closest('#save-enrollment-btn')) {
                    const studentId = target.closest('#save-enrollment-btn').dataset.studentId;
                    const batch = writeBatch(db);
                    enrollments.filter(e => e.studentId === studentId).forEach(e => batch.delete(doc(db, "enrollments", e.id)));
                    document.querySelectorAll('#edit-student-modal input[type="checkbox"]:checked').forEach(box => {
                        const newEnrollmentRef = doc(collection(db, "enrollments"));
                        batch.set(newEnrollmentRef, { studentId: studentId, courseId: box.dataset.courseId });
                    });
                    await batch.commit();
                    closeModal();
                    showToast('C·∫≠p nh·∫≠t ghi danh th√†nh c√¥ng!', 'success');
                }
                if (target.closest('.view-course-detail-btn')) { showModal(renderCourseDetailModal(target.closest('.view-course-detail-btn').dataset.id)); }
            }
            
            if (currentUser?.role === 'teacher') {
                if (target.closest('.edit-course-btn')) { showModal(renderEditCourseModal(target.closest('.edit-course-btn').dataset.id)); }
                if (target.closest('#save-course-btn')) {
                    const courseId = target.closest('#save-course-btn').dataset.courseId;
                    const title = document.getElementById('edit-course-title').value;
                    const description = document.getElementById('edit-course-desc').value;
                    const submissionFolderUrl = document.getElementById('edit-course-folder-url').value;
                    if (title && description) {
                        await updateDoc(doc(db, 'courses', courseId), { title, description, submissionFolderUrl });
                        closeModal();
                        showToast('C·∫≠p nh·∫≠t kh√≥a h·ªçc th√†nh c√¥ng', 'success');
                    } else { showToast("Vui l√≤ng ƒëi·ªÅn ƒë·ªß ti√™u ƒë·ªÅ v√† m√¥ t·∫£.", 'error'); }
                }
                if (target.closest('#add-course-btn')) {
                    const title = document.getElementById('new-course-title').value;
                    const description = document.getElementById('new-course-desc').value;
                    const folderUrl = document.getElementById('new-course-folder-url').value;
                    if (title && description) {
                        await addDoc(collection(db, 'courses'), { title, description, createdBy: currentUser.id, submissionFolderUrl: folderUrl });
                        showToast('T·∫°o kh√≥a h·ªçc th√†nh c√¥ng', 'success');
                    } else { showToast("Vui l√≤ng ƒëi·ªÅn ƒë·ªß ti√™u ƒë·ªÅ v√† m√¥ t·∫£.", 'error'); }
                }
                if (target.closest('.manage-course-btn')) { 
                    overviewFilterLessonId = 'all';
                    currentCourseId = target.closest('.manage-course-btn').dataset.id;
                    currentView = 'course';
                    navigate();
                }
                if (target.closest('#add-lesson-btn')) {
                    const courseId = target.closest('#add-lesson-btn').dataset.courseId;
                    const title = document.getElementById('new-lesson-title').value;
                    const content = document.getElementById('new-lesson-content').value;
                    const videoUrl = document.getElementById('new-lesson-video').value;
                    
                    // L·∫•y c√°c k·ªπ nƒÉng ƒë∆∞·ª£c ch·ªçn
                    const selectedSkills = Array.from(document.querySelectorAll('.lesson-skill-checkbox:checked')).map(cb => cb.value);
                    
                    if(title && content) {
                        if (selectedSkills.length === 0) {
                            showToast('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt k·ªπ nƒÉng s·∫Ω d·∫°y', 'error');
                            return;
                        }
                        await addDoc(collection(db, 'lessons'), { courseId, title, content, videoUrl, skillsToTeach: selectedSkills, createdAt: serverTimestamp() });
                        
                        // Clear input
                        document.getElementById('new-lesson-title').value = '';
                        document.getElementById('new-lesson-video').value = '';
                        document.getElementById('new-lesson-content').value = '';
                        document.querySelectorAll('.lesson-skill-checkbox').forEach(cb => cb.checked = false);
                        
                        showToast('Th√™m b√†i h·ªçc th√†nh c√¥ng', 'success');
                    } else { showToast("Vui l√≤ng ƒëi·ªÅn ƒë·ªß ti√™u ƒë·ªÅ v√† n·ªôi dung.", 'error'); }
                }
                if (target.closest('.edit-lesson-btn')) { showModal(renderEditLessonModal(target.closest('.edit-lesson-btn').dataset.lessonId)); }
                if (target.closest('#save-lesson-btn')) {
                    const lessonId = target.closest('#save-lesson-btn').dataset.lessonId;
                    const title = document.getElementById('edit-lesson-title').value;
                    const videoUrl = document.getElementById('edit-lesson-video').value;
                    const content = document.getElementById('edit-lesson-content').value;
                    
                    // L·∫•y c√°c k·ªπ nƒÉng ƒë∆∞·ª£c ch·ªçn
                    const selectedSkills = Array.from(document.querySelectorAll('.edit-lesson-skill-checkbox:checked')).map(cb => cb.value);
                    
                    if (selectedSkills.length === 0) {
                        showToast('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt k·ªπ nƒÉng s·∫Ω d·∫°y', 'error');
                        return;
                    }
                    
                    await updateDoc(doc(db, 'lessons', lessonId), { title, videoUrl, content, skillsToTeach: selectedSkills });
                    closeModal();
                    showToast('C·∫≠p nh·∫≠t b√†i h·ªçc th√†nh c√¥ng', 'success');
                }
                 if (target.closest('.delete-lesson-btn')) {
                    const lessonId = target.dataset.lessonId;
                    renderConfirmModal(
                        'X√°c nh·∫≠n X√≥a B√†i h·ªçc',
                        'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i h·ªçc n√†y? M·ªçi b√†i t·∫≠p v√† ƒëi·ªÉm s·ªë li√™n quan c≈©ng s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn.',
                        'X√≥a',
                        'bg-red-600 hover:bg-red-700',
                        async () => {
                            const batch = writeBatch(db);
                            progress.filter(p => p.lessonId === lessonId).forEach(p => batch.delete(doc(db, "progress", p.id)));
                            homeworks.filter(h => h.lessonId === lessonId).forEach(h => batch.delete(doc(db, "homeworks", h.id)));
                            batch.delete(doc(db, 'lessons', lessonId));
                            await batch.commit();
                            showToast('ƒê√£ x√≥a b√†i h·ªçc', 'success');
                        }
                    );
                }
                
                if (target.closest('.manage-homework-btn')) { 
                    showModal(renderHomeworkModal(target.closest('.manage-homework-btn').dataset.lessonId)); 
                }
                if (target.closest('#save-homework-btn')) {
                    const lessonId = target.closest('#save-homework-btn').dataset.lessonId;
                    const homeworkId = target.closest('#save-homework-btn').dataset.homeworkId;
                    const title = document.getElementById('homework-title').value;
                    const description = document.getElementById('homework-desc').value;
                    if (title && description) {
                        if (homeworkId) {
                            await updateDoc(doc(db, 'homeworks', homeworkId), { title, description });
                        } else {
                            await addDoc(collection(db, 'homeworks'), { lessonId, title, description });
                        }
                        closeModal();
                        showToast('L∆∞u b√†i t·∫≠p th√†nh c√¥ng', 'success');
                    } else { showToast("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin.", 'error'); }
                }
                if (target.closest('#delete-homework-btn')) {
                    const homeworkId = target.dataset.homeworkId;
                    renderConfirmModal(
                        'X√°c nh·∫≠n X√≥a B√†i t·∫≠p',
                        'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i t·∫≠p n√†y?',
                        'X√≥a',
                        'bg-red-600 hover:bg-red-700',
                        async () => {
                            await deleteDoc(doc(db, 'homeworks', homeworkId));
                            // closeModal() ƒë∆∞·ª£c g·ªçi b·ªüi renderConfirmModal
                            showToast('ƒê√£ x√≥a b√†i t·∫≠p', 'success');
                        }
                    );
                }
                if(target.closest('.tab-btn')) {
                    const tabName = target.dataset.tab;
                    currentActiveTab = tabName; // L∆∞u tab ƒë∆∞·ª£c ch·ªçn
                    localStorage.setItem('currentActiveTab', tabName); // L∆∞u v√†o localStorage
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.classList.remove('tab-active');
                        btn.classList.add('text-gray-500', 'hover:text-gray-700');
                    });
                    target.classList.add('tab-active');
                    target.classList.remove('text-gray-500', 'hover:text-gray-700');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(`tab-${tabName}`).classList.remove('hidden');
                }
                if (target.closest('.view-student-progress-btn')) {
                    currentStudentIdForProgress = target.closest('.view-student-progress-btn').dataset.studentId;
                    currentView = 'studentReport';
                    navigate();
                }
                if (target.closest('#edit-student-progress-btn')) {
                    currentStudentIdForProgress = target.closest('#edit-student-progress-btn').dataset.studentId;
                    currentView = 'studentProgress';
                    navigate();
                }
                if (target.closest('.lesson-progress-summary')) {
                    const summaryCard = target.closest('.lesson-progress-summary');
                    const studentId = summaryCard.dataset.studentId;
                    const lessonId = summaryCard.dataset.lessonId;
                    renderEditProgressModal(studentId, lessonId);
                }
                if (target.closest('.edit-progress-shortcut-btn')) {
                    const btn = target.closest('.edit-progress-shortcut-btn');
                    renderEditProgressModal(btn.dataset.studentId, btn.dataset.lessonId);
                }
                 if (target.closest('.attendance-btn-group .attendance-btn')) {
                     const group = target.closest('.attendance-btn-group');
                     group.querySelectorAll('.attendance-btn').forEach(btn => {
                         btn.classList.remove('attendance-btn-active', 'bg-red-500', 'bg-yellow-500', 'bg-orange-500');
                         if(!btn.classList.contains('bg-white')) btn.classList.add('bg-white', 'hover:bg-slate-100');
                     });

                     const status = target.dataset.status;
                     target.classList.add('attendance-btn-active');
                     target.classList.remove('bg-white', 'hover:bg-slate-100');
                     if (status === 'absent_unexcused') target.classList.add('bg-red-500');
                     if (status === 'absent_excused') target.classList.add('bg-yellow-500');
                     if (status === 'late') target.classList.add('bg-orange-500');
                 }
                 if (target.closest('#save-progress-btn')) {
                     const button = target.closest('#save-progress-btn');
                     const studentId = button.dataset.studentId;
                     const lessonId = button.dataset.lessonId;
                     const recordId = `${lessonId}_${studentId}`;
                     
                     // L·∫•y b√†i h·ªçc ƒë·ªÉ bi·∫øt k·ªπ nƒÉng n√†o ƒë∆∞·ª£c d·∫°y
                     const lesson = lessons.find(l => l.id === lessonId);
                     const skillsToTeach = lesson?.skillsToTeach || [];
                     
                     const readingScore = document.getElementById('edit-reading-score').value;
                     const listeningScore = document.getElementById('edit-listening-score').value;
                     const speakingScore = document.getElementById('edit-speaking-score').value;
                     const writingScore = document.getElementById('edit-writing-score').value;

                     const newGrades = {
                         reading: skillsToTeach.includes('reading') ? (readingScore ? parseFloat(readingScore) : null) : 0,
                         listening: skillsToTeach.includes('listening') ? (listeningScore ? parseFloat(listeningScore) : null) : 0,
                         speaking: skillsToTeach.includes('speaking') ? (speakingScore ? parseFloat(speakingScore) : null) : 0,
                         writing: skillsToTeach.includes('writing') ? (writingScore ? parseFloat(writingScore) : null) : 0,
                     };

                     // Ch·ªâ l·∫•y ƒëi·ªÉm c·ªßa c√°c k·ªπ nƒÉng ƒë∆∞·ª£c d·∫°y (kh√¥ng l·∫•y nh·ªØng k·ªπ nƒÉng = 0)
                     const taughtSkillScores = Object.keys(newGrades)
                         .filter(skill => skillsToTeach.includes(skill) && newGrades[skill] !== null)
                         .map(skill => newGrades[skill]);
                     
                     let averageScore = null;
                     if (taughtSkillScores.length > 0) {
                         averageScore = parseFloat((taughtSkillScores.reduce((a, b) => a + b, 0) / taughtSkillScores.length).toFixed(1));
                     }
                     
                     const newComment = document.getElementById('edit-comment-input').value;
                     
                     const activeButton = document.querySelector('.attendance-btn.attendance-btn-active');
                     const newStatus = activeButton ? activeButton.dataset.status : null;

                     const dataToSave = {
                         grade: averageScore,
                         grades: newGrades,
                         comment: newComment,
                         attendanceStatus: newStatus,
                         studentId,
                         lessonId,
                         courseId: currentCourseId
                     };

                     await setDoc(doc(db, 'progress', recordId), dataToSave, { merge: true });
                     closeModal();
                     showToast('ƒê√£ l∆∞u ti·∫øn ƒë·ªô!', 'success');
                 }
            }
            
            if (currentUser?.role === 'student') {
                if (target.closest('.view-course-btn')) { 
                    currentCourseId = target.closest('.view-course-btn').dataset.id;
                    currentView = 'course';
                    navigate();
                }
                if (target.closest('.view-lesson-btn')) {
                    currentLessonId = target.closest('.view-lesson-btn').dataset.lessonId;
                    currentView = 'lesson';
                    navigate();
                }
                if (target.closest('.confirm-submission-btn')) {
                    const lessonId = target.closest('.confirm-submission-btn').dataset.lessonId;
                    const recordId = `${lessonId}_${currentUser.id}`;
                    await setDoc(doc(db, "progress", recordId), { lessonId, studentId: currentUser.id, courseId: currentCourseId, submittedAt: serverTimestamp() }, { merge: true });
                    showToast('X√°c nh·∫≠n n·ªôp b√†i th√†nh c√¥ng!', 'success');
                }
                if (target.closest('.cancel-submission-btn')) {
                    const lessonId = target.dataset.lessonId;
                    renderConfirmModal(
                        'X√°c nh·∫≠n h·ªßy',
                        'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy n·ªôp b√†i kh√¥ng?',
                        'ƒê·ªìng √Ω',
                        'bg-red-600 hover:bg-red-700',
                        async () => {
                            const recordId = `${lessonId}_${currentUser.id}`;
                            const progressDocRef = doc(db, "progress", recordId);
                            await updateDoc(progressDocRef, { submittedAt: deleteField() });
                            showToast('ƒê√£ h·ªßy x√°c nh·∫≠n n·ªôp b√†i.', 'info');
                        }
                    );
                }
                if (target.closest('.view-my-progress-btn')) {
                    currentCourseId = target.closest('.view-my-progress-btn').dataset.courseId;
                    currentView = 'myProgress';
                    navigate();
                }
            }
        });
        
        document.body.addEventListener('input', (e) => {
             if (e.target.classList.contains('score-input')) {
                 calculateAverageScore();
             }
        });
        document.body.addEventListener('change', async (e) => {
             const target = e.target;
             if (target.id === 'admin-teacher-select') {
                 const teacherId = target.value;
                 const courseSelect = document.getElementById('admin-course-select');
                 courseSelect.innerHTML = '<option value="">-- Ch·ªçn kho√° h·ªçc --</option>';
                 if (teacherId) {
                     const teacherCourses = courses.filter(c => c.createdBy === teacherId);
                     courseSelect.innerHTML += teacherCourses.map(c => `<option value="${c.id}">${c.title}</option>`).join('');
                     courseSelect.disabled = teacherCourses.length === 0;
                 } else {
                     courseSelect.disabled = true;
                 }
             }
             if (target.id === 'overview-filter') {
                 overviewFilterLessonId = target.value;
                 updateTeacherCourseTabs();
             }
        });

        // ===================================================================================
        // KHU V·ª∞C 7: KH·ªûI ƒê·ªòNG ·ª®NG D·ª§NG
        // ===================================================================================
        async function startApp() {
            if (!db || !auth) return;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    let initialLoadComplete = false;
                    const collectionsToWatch = ['users', 'courses', 'lessons', 'homeworks', 'progress', 'enrollments'];
                    const initialLoads = new Set();

                    collectionsToWatch.forEach(colName => {
                        onSnapshot(collection(db, colName), (snapshot) => {
                            const dataArray = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            if (colName === 'users') users = dataArray;
                            else if (colName === 'courses') courses = dataArray;
                            else if (colName === 'lessons') lessons = dataArray;
                            else if (colName === 'homeworks') homeworks = dataArray;
                            else if (colName === 'progress') progress = dataArray;
                            else if (colName === 'enrollments') enrollments = dataArray;

                            if (!initialLoadComplete) {
                                initialLoads.add(colName);
                                
                                if (initialLoads.size === collectionsToWatch.length) {
                                    initialLoadComplete = true;
                                    
                                    // Kh√¥i ph·ª•c currentUser t·ª´ localStorage
                                    const savedUserId = localStorage.getItem('currentUserId');
                                    if (savedUserId) {
                                        const foundUser = users.find(u => u.id === savedUserId);
                                        if (foundUser) {
                                            currentUser = foundUser;
                                            
                                            // Kh√¥i ph·ª•c tr·∫°ng th√°i view t·ª´ localStorage
                                            const savedView = localStorage.getItem('currentView');
                                            const savedCourseId = localStorage.getItem('currentCourseId');
                                            const savedLessonId = localStorage.getItem('currentLessonId');
                                            const savedStudentId = localStorage.getItem('currentStudentIdForProgress');
                                            const savedActiveTab = localStorage.getItem('currentActiveTab');
                                            
                                            // Ch·ªâ kh√¥i ph·ª•c n·∫øu c√≥ gi√° tr·ªã h·ª£p l·ªá
                                            if (savedView && savedView !== 'login' && savedView !== '') {
                                                currentView = savedView;
                                                if (savedCourseId && savedCourseId !== '') currentCourseId = savedCourseId;
                                                if (savedLessonId && savedLessonId !== '') currentLessonId = savedLessonId;
                                                if (savedStudentId && savedStudentId !== '') currentStudentIdForProgress = savedStudentId;
                                                if (savedActiveTab && savedActiveTab !== '') currentActiveTab = savedActiveTab;
                                                
                                                // ƒê·∫∑t c·ªù ƒë·ªÉ navigate() bi·∫øt ƒë√¢y l√† l·∫ßn kh√¥i ph·ª•c ƒë·∫ßu ti√™n
                                                // N√≥ s·∫Ω kh√¥ng l∆∞u l·∫°i localStorage, gi·ªØ nguy√™n c√°c gi√° tr·ªã
                                                isFirstNavigationAfterRestore = true;
                                            } else {
                                                // N·∫øu kh√¥ng c√≥ saved view, m·∫∑c ƒë·ªãnh l√† dashboard
                                                currentView = 'dashboard';
                                            }
                                        } else {
                                            localStorage.removeItem('currentUserId');
                                            localStorage.removeItem('currentView');
                                            localStorage.removeItem('currentCourseId');
                                            localStorage.removeItem('currentLessonId');
                                            localStorage.removeItem('currentStudentIdForProgress');
                                            currentUser = null;
                                        }
                                    }
                                    
                                    const loadingOverlay = document.getElementById('loading-overlay');
                                    loadingOverlay.style.opacity = '0';
                                    setTimeout(() => {
                                        loadingOverlay.style.display = 'none';
                                        navigate();
                                    }, 300);
                                }
                            } else {
                                // Sau khi t·∫£i l·∫ßn ƒë·∫ßu, n·∫øu collection 'users' thay ƒë·ªïi, c·∫≠p nh·∫≠t currentUser
                                if (colName === 'users' && currentUser) {
                                    const refreshedUser = users.find(u => u.id === currentUser.id);
                                    if (refreshedUser) {
                                        currentUser = refreshedUser;
                                    } else {
                                        localStorage.removeItem('currentUserId');
                                        currentUser = null;
                                        navigate();
                                        return;
                                    }
                                }
                                updateUI();
                            }
                        }, (error) => {
                            console.error(`L·ªói khi l·∫Øng nghe collection ${colName}:`, error);
                            document.getElementById('loading-overlay').innerHTML = `<div class="text-center p-4">
                                <p class="text-red-500 font-semibold">L·ªói quy·ªÅn truy c·∫≠p!</p>
                                <p class="text-slate-600 mt-2 text-sm">Vui l√≤ng ki·ªÉm tra l·∫°i <strong>Quy t·∫Øc B·∫£o m·∫≠t (Security Rules)</strong> trong Firebase.</p>
                            </div>`;
                        });
                    });
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("L·ªói ƒëƒÉng nh·∫≠p ·∫©n danh:", error);
                        showToast('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß x√°c th·ª±c.', 'error');
                    }
                }
            });
        }

        startApp();

    </script>
</body>
</html>
